<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog Media Gallery â€” Lightbox click & loop-limit fixes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://player.vimeo.com/api/player.js"></script>
  <style>
    :root{
      /* Config-populated variables */
      --border-radius: 12px;
      --gap-size: 8px;

      /* Preview play (strip) */
      --preview-play-circle-size-d: 34px;
      --preview-play-circle-size-m: 30px;
      --preview-play-icon-size: 1.1rem;

      /* Host play defaults (main / lightbox) */
      --play-btn-size-d: 96px;
      --play-btn-size-m: 78px;
      --play-circle-size-d: 66px;
      --play-circle-size-m: 56px;
      --play-icon-size: 1.4rem;

      --preview-size-d: 65px;
      --preview-size-m: 55px;
      --preview-border-width: 4px;
      --preview-border-active: #0073e6;
      --preview-border-inactive: transparent;

      --main-aspect-ratio: 16/9;
      --lightbox-padding: 1rem;
    }

    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;padding:2rem;background:#fafafa;}
    .no-scroll{overflow:hidden;}

    .blog-image{max-width:800px;width:100%;aspect-ratio:var(--main-aspect-ratio);border-radius:var(--border-radius);box-shadow:0 4px 15px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:var(--gap-size);background:#ddd;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center;}
    .blog-image img{display:block;width:100%;height:100%;object-fit:cover;border-radius:var(--border-radius);}
    .blog-image .media-host{display:flex;align-items:center;justify-content:center;background:transparent;border-radius:var(--border-radius);overflow:hidden;position:relative;}

    .skeleton{position:relative; background: #eaeaea; }
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: translateX(-100%); animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 100% { transform: translateX(100%); } }

    .previews{display:flex;gap:var(--gap-size);overflow-x:auto;max-width:800px;width:100%;padding-bottom:0.5rem;visibility:hidden;}
    .previews.visible{visibility:visible;}
    .previews.hidden{display:none;}
    .preview{
      flex:0 0 auto;
      width:var(--preview-size-d); height:var(--preview-size-d);
      border-radius:var(--border-radius); overflow:hidden; cursor:pointer;
      border:var(--preview-border-width) solid var(--preview-border-inactive);
      transition:transform .3s ease,border .3s ease; position:relative; background:#e5e5e5;
    }
    .preview img,.preview video{width:100%;height:100%;object-fit:cover;display:block;border-radius:calc(var(--border-radius) - 2px);}
    .preview .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;font-size:var(--preview-play-icon-size);color:rgba(255,255,255,.95);text-shadow:0 2px 6px rgba(0,0,0,.5); z-index:5;}
    .preview .play-overlay .circle{width:var(--preview-play-circle-size-d);height:var(--preview-play-circle-size-d);border-radius:50%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;}
    .preview.active{border-color:var(--preview-border-active);transform:scale(.9);}

    .play-btn{
      position:absolute;left:50%;top:50%;
      width:var(--play-btn-size-d); height:var(--play-btn-size-d);
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      pointer-events:auto; transform:translate(-50%,-50%) scale(.6); opacity:0; transform-origin:center; z-index:3;
    }
    .play-btn .circle{
      width:var(--play-circle-size-d); height:var(--play-circle-size-d);
      border-radius:50%; background:rgba(0,0,0,.6);
      display:flex; align-items:center; justify-content:center; color:#fff; font-size:var(--play-icon-size);
    }

    .galleryViewer{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;opacity:0;z-index:9999;}
    .galleryViewer.active{display:flex;}
    .galleryViewer .imgBox{
      width:95%;
      max-width:95%;
      max-height:calc(100% - (var(--lightbox-padding)*2 + 45px + 45px));
      height:calc(100% - (var(--lightbox-padding)*2 + 45px + 45px));
      display:flex;justify-content:center;align-items:center;position:relative;background:transparent;border-radius:var(--border-radius);overflow:visible;
      /* overflow visible so scaled host can show letter/pillar boxing */
    }
    .galleryViewer .imgBox .media-host{display:flex;align-items:center;justify-content:center;background:transparent;border-radius:var(--border-radius);overflow:visible;position:relative;}
    .galleryViewer .imgBox img,
    .galleryViewer .imgBox video,
    .galleryViewer .imgBox iframe{max-width:100%;max-height:100%;border:0;border-radius:var(--border-radius);background:transparent;display:block;}

    .galleryViewer .arrows{position:absolute;bottom:var(--lightbox-padding);left:0;width:100%;display:flex;justify-content:space-between;padding:0 1rem;pointer-events:auto;z-index:30;}
    .galleryViewer .arrows span{background:white;font-size:1.2rem;width:45px;height:45px;display:flex;justify-content:center;align-items:center;border-radius:50%;cursor:pointer;transition:300ms ease;}
    .galleryViewer .arrows span:hover{background:rgba(255,255,255,.7);}
    .galleryViewer .close{width:45px;height:45px;background:red;display:flex;justify-content:center;align-items:center;color:white;cursor:pointer;position:absolute;top:var(--lightbox-padding);right:var(--lightbox-padding);border-radius:50%;z-index:40;}
    .galleryViewer .close:hover{background:rgba(255,0,0,.7);}

    .crossfade{position:absolute;inset:0;width:100%;height:100%;}

    /* Vimeo mini preview (strip) */
    .preview .vimeo-mini{position:relative;width:100%;height:100%;overflow:hidden;border-radius:calc(var(--border-radius) - 2px);background:#000;}
    .preview .vimeo-mini iframe{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:0;pointer-events:none;border-radius:inherit;background:transparent;}
    .preview .vimeo-mini img.vimeo-mini-poster{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;border-radius:inherit;transition:opacity .25s ease;z-index:1;}

    @media(max-width:768px){
      body{padding:.5rem}
      .preview{width:var(--preview-size-m); height:var(--preview-size-m);}
      .play-btn{width:var(--play-btn-size-m); height:var(--play-btn-size-m);}
      .play-btn .circle{width:var(--play-circle-size-m); height:var(--play-circle-size-m);}
      .preview .play-overlay .circle{width:var(--preview-play-circle-size-m);height:var(--preview-play-circle-size-m);}
    }
  </style>
</head>
<body>

  <div class="blog-image" id="mainImageBox" aria-label="Main media">
    <div class="skeleton" style="width:100%;height:100%;border-radius:var(--border-radius);"></div>
  </div>
  <div class="previews" id="previewContainer" aria-label="Media previews"></div>

  <div class="galleryViewer" id="galleryViewer" aria-modal="true" role="dialog">
    <div class="imgBox"></div>
    <div class="arrows"><span class="prev" aria-label="Previous"><i class="fa-solid fa-arrow-left"></i></span><span class="next" aria-label="Next"><i class="fa-solid fa-arrow-right"></i></span></div>
    <div class="close" aria-label="Close"><i class="fa-solid fa-xmark"></i></div>
  </div>

<script>
/* -------------------------
   CONFIG
   ------------------------- */
const CONFIG = {
  styles: {
    borderRadius: 12,
    gap: 8,
    mainAspectRatio: "16/9",
    preview: { sizeDesktop: 65, sizeMobile: 55, borderWidth: 4, activeBorder: "#0073e6", inactiveBorder: "transparent" },
    playButton: {
      preview: { circleDesktop: 34, circleMobile: 30, iconSize: "1.1rem" },
      main:    { btnDesktop: 96, btnMobile: 78, circleDesktop: 66, circleMobile: 56, iconSize: "1.4rem" },
      lightbox:{ btnDesktop: 96, btnMobile: 78, circleDesktop: 66, circleMobile: 56, iconSize: "1.4rem" }
    },
    lightboxPadding: "1rem"
  },
  behavior: {
    idleTimeoutMs: 10000,
    previewLoopSeconds: 5,
    vimeoMiniQuality: "240p",
    validationTimeouts: { image: 1100, thumb: 900, poster: 900, video: 1300, vimeoOembed: 1500 },
    vimeoMetaRetryDelay: 3000,
    vimeoMetaRetryAttempts: 2,
    /* NEW: number of loops before returning to static thumbnail.
       0 => infinite looping (no auto-stop). Positive integer enforces limit. */
    previewLoopMaxIterations: 3
  }
};

/* Example JSON data (you can switch to a dynamic JSON loading approach) */
const GALLERY_DATA = [
  { type: "image", src: "media/image1.jpg", alt: "Sunlight over ridge" },
  { type: "image", src: "media/image2.jpg", alt: "Forest path" },
  { type: "image", src: "media/image3.jpg", alt: "City skyline" },
  { type: "video", src: "media/video2.mp4", poster: "media/image1.jpg", alt: "Local surfing clip" },
  { type: "vimeo", src: "https://vimeo.com/1112464020", poster: "media/my-local-vimeo-thumb.jpg", alt: "Vimeo: city timelapse" },
  { type: "image", src: "media/image4.jpg", alt: "Lake reflection" }
];

/* Apply style vars */
(function applyStyleVars(cfg){
  const r = document.documentElement.style;
  const s = cfg.styles;
  r.setProperty('--border-radius', s.borderRadius + 'px');
  r.setProperty('--gap-size', s.gap + 'px');
  r.setProperty('--main-aspect-ratio', s.mainAspectRatio);
  r.setProperty('--lightbox-padding', s.lightboxPadding);

  r.setProperty('--preview-size-d', s.preview.sizeDesktop + 'px');
  r.setProperty('--preview-size-m', s.preview.sizeMobile + 'px');
  r.setProperty('--preview-border-width', s.preview.borderWidth + 'px');
  r.setProperty('--preview-border-active', s.preview.activeBorder);
  r.setProperty('--preview-border-inactive', s.preview.inactiveBorder);

  r.setProperty('--preview-play-circle-size-d', s.playButton.preview.circleDesktop + 'px');
  r.setProperty('--preview-play-circle-size-m', s.playButton.preview.circleMobile + 'px');
  r.setProperty('--preview-play-icon-size', s.playButton.preview.iconSize);

  r.setProperty('--play-btn-size-d', s.playButton.main.btnDesktop + 'px');
  r.setProperty('--play-btn-size-m', s.playButton.main.btnMobile + 'px');
  r.setProperty('--play-circle-size-d', s.playButton.main.circleDesktop + 'px');
  r.setProperty('--play-circle-size-m', s.playButton.main.circleMobile + 'px');
  r.setProperty('--play-icon-size', s.playButton.main.iconSize);
})(CONFIG);

/* -------------------------
   DOM refs & state
   ------------------------- */
const mainImageBox = document.getElementById('mainImageBox');
const previewContainer = document.getElementById('previewContainer');
const galleryViewer = document.getElementById('galleryViewer');
const imgBox = galleryViewer.querySelector('.imgBox');
const nextBtn = galleryViewer.querySelector('.next');
const prevBtn = galleryViewer.querySelector('.prev');
const closeBtn = galleryViewer.querySelector('.close');

let previews = [];
let currentIndex = 0, isAnimating = false, startIndex = 0;
let mainIdleTimer = null, mainVideoEl = null, lightboxIdleTimer = null, lightboxVideoEl = null;
let mainVimeoRef = null, lightboxVimeoRef = null;

const IDLE_TIMEOUT = CONFIG.behavior.idleTimeoutMs;
const PREVIEW_DURATION = CONFIG.behavior.previewLoopSeconds;
const LOOP_LIMIT = Math.max(0, Number(CONFIG.behavior.previewLoopMaxIterations || 0)); // 0 means infinite

const vimeoMetaCache = new Map();
const vimeoPosterCache = new Map();
const vimeoPlayerMap = new Map();
const vimeoMiniMap = new Map();
const VIMEO_PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 675"><rect width="1200" height="675" fill="#111"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#666" font-family="Arial" font-size="42">Loadingâ€¦</text></svg>`);

/* -------------------------
   Small helpers
   ------------------------- */
const isVideoTag = (el) => el && el.tagName && el.tagName.toLowerCase() === 'video';
const mediaOf = (previewEl) => previewEl && previewEl.querySelector('img,video');
const getPreviewType = (p) => (p && p.dataset && (p.dataset.type || 'image')).toLowerCase();

function animateOverlayIn(overlay) {
  if (!overlay) return;
  overlay.style.transform = "translate(-50%,-50%) scale(.6)";
  overlay.style.opacity = "0";
  gsap.fromTo(overlay, { scale: 0.6, opacity: 0 }, { scale: 1.05, opacity: 1, duration: 0.18, ease: "back.out(3)", onComplete: () => gsap.to(overlay, { scale: 1, duration: 0.06, ease: "power1.out" }) });
}

/* Image/video validations (fast) */
function validateImageUrl(url, timeout = CONFIG.behavior.validationTimeouts.image) {
  return new Promise((resolve) => {
    if (!url) { resolve(false); return; }
    const img = new Image(); let done = false;
    const t = setTimeout(() => { if (!done) { done = true; resolve(false); } }, timeout);
    img.onload = () => { if (!done) { done = true; clearTimeout(t); resolve(true); } };
    img.onerror = () => { if (!done) { done = true; clearTimeout(t); resolve(false); } };
    img.src = url;
  });
}
function validateVideoUrl(url, timeout = CONFIG.behavior.validationTimeouts.video) {
  return new Promise((resolve) => {
    if (!url) { resolve(false); return; }
    const v = document.createElement('video'); let done = false;
    const t = setTimeout(() => { if (!done) { done = true; resolve(false); } }, timeout);
    v.preload = 'metadata';
    v.onloadedmetadata = () => { if (!done) { done = true; clearTimeout(t); resolve(true); } };
    v.onerror = () => { if (!done) { done = true; clearTimeout(t); resolve(false); } };
    v.src = url;
  });
}

/* Vimeo helpers */
function extractVimeoId(url = '') {
  const patterns = [/vimeo\.com\/(?:video\/)?(\d+)/, /player\.vimeo\.com\/video\/(\d+)/];
  for (const re of patterns) { const m = (url || '').match(re); if (m && m[1]) return m[1]; }
  return null;
}
async function fetchVimeoMeta(url) {
  if (!url) return null;
  if (vimeoMetaCache.has(url)) return vimeoMetaCache.get(url);
  try {
    const res = await fetch('https://vimeo.com/api/oembed.json?width=960&url=' + encodeURIComponent(url), { mode: 'cors' });
    if (!res.ok) throw new Error('bad oembed');
    const data = await res.json();
    let thumb = data.thumbnail_url || null;
    if (thumb && /_\d+x?\.(jpg|png)$/.test(thumb)) { thumb = thumb.replace(/_\d+x?\.(jpg|png)$/, "_960.jpg"); }
    const width = data.width || 16, height = data.height || 9;
    const ratio = width / height;
    const meta = { thumb, width, height, ratio };
    vimeoMetaCache.set(url, meta);
    return meta;
  } catch (e) { return null; }
}

/* Host sizing utilities: size host to actual media aspect */
function sizeHostToAspect(container, host, aspect) {
  if (!container || !host || !aspect) return;
  const boxW = container.clientWidth;
  const boxH = container.clientHeight;
  let targetW, targetH;
  if (boxW / boxH > aspect) { // container is wider than media -> letterbox
    targetH = boxH;
    targetW = Math.min(boxW, Math.round(targetH * aspect));
  } else { // container is taller -> pillarbox
    targetW = boxW;
    targetH = Math.min(boxH, Math.round(targetW / aspect));
  }
  host.style.width = targetW + "px";
  host.style.height = targetH + "px";
}
function attachResponsiveSizer(container, host, getAspect) {
  if (host._ro) try { host._ro.disconnect(); } catch (e) { }
  if (host._onResize) window.removeEventListener('resize', host._onResize);
  const ro = new ResizeObserver(() => { const ar = getAspect(); if (ar) sizeHostToAspect(container, host, ar); });
  ro.observe(container);
  const onResize = () => { const ar = getAspect(); if (ar) sizeHostToAspect(container, host, ar); };
  window.addEventListener('resize', onResize);
  host._ro = ro; host._onResize = onResize;
  requestAnimationFrame(() => { const ar = getAspect(); if (ar) sizeHostToAspect(container, host, ar); });
}

/* Destroy any vimeo players in a node */
function destroyVimeoPlayersIn(node) {
  const iframes = node.querySelectorAll("iframe[data-vimeo-iframe='1']");
  if (!iframes.length) return;
  iframes.forEach((ifr) => {
    const pl = vimeoPlayerMap.get(ifr);
    try { pl?.unload?.(); } catch (e) { }
    vimeoPlayerMap.delete(ifr);
    try { ifr.remove(); } catch (e) { }
  });
}

/* -------------------------
   Idle previews and loop-limit handling
   ------------------------- */

/* Local video idle preview logic in main/lightbox */
const clearMainIdleAndPreview = () => {
  if (mainIdleTimer) { clearTimeout(mainIdleTimer); mainIdleTimer = null; }
  if (mainVideoEl) {
    try {
      if (mainVideoEl._previewLoopActive) {
        mainVideoEl._previewLoopActive = false;
        mainVideoEl.removeEventListener("timeupdate", mainVideoEl._previewTimeHandler);
      }
    } catch (e) { }
  }
};
const clearLightboxIdleAndPreview = () => {
  if (lightboxIdleTimer) { clearTimeout(lightboxIdleTimer); lightboxIdleTimer = null; }
  if (lightboxVideoEl) {
    try {
      if (lightboxVideoEl._previewLoopActive) {
        lightboxVideoEl._previewLoopActive = false;
        lightboxVideoEl.removeEventListener("timeupdate", lightboxVideoEl._previewTimeHandler);
      }
    } catch (e) { }
  }
};

const attachIdleLogicToVideo = (v, index, scope) => {
  if (scope === "main") { clearMainIdleAndPreview(); mainVideoEl = v; } else { clearLightboxIdleAndPreview(); lightboxVideoEl = v; }
  v.controls = false; v.playsInline = true; v.preload = "auto";
  v._previewLoopActive = false; v._hasEndedPlaying = false; v._previewLoopCount = 0;

  const onEnded = () => { v._hasEndedPlaying = true; if (v._previewLoopActive) { v._previewLoopActive = false; v.removeEventListener("timeupdate", v._previewTimeHandler); } };
  v.addEventListener("ended", onEnded);

  const stopPreview = () => {
    try {
      if (v._previewLoopActive) {
        v._previewLoopActive = false;
        v.removeEventListener("timeupdate", v._previewTimeHandler);
        v._previewTimeHandler = null;
        v.pause(); v.currentTime = 0;
      }
    } catch (e) { }
  };

  const startPreview = () => {
    try {
      v.muted = true; v.controls = false; v._previewLoopActive = true; v.currentTime = 0;
      v._previewLoopCount = 0;
      const proxy = v.parentElement && v.parentElement.querySelector('.poster-proxy');
      let fadedProxy = false;
      v._previewTimeHandler = function () {
        if (!fadedProxy && v.currentTime > 0.05) {
          fadedProxy = true;
          if (proxy) { gsap.to(proxy, { opacity: 0, duration: 0.25, onComplete: () => { try { proxy.remove(); } catch (e) { } } }); }
        }
        if (v.currentTime >= PREVIEW_DURATION) {
          v._previewLoopCount = (v._previewLoopCount || 0) + 1;
          if (LOOP_LIMIT > 0 && v._previewLoopCount >= LOOP_LIMIT) {
            // stop loop and revert to poster
            try { stopPreview(); if (proxy) { proxy.style.opacity = '1'; } if (v.parentElement && proxy) { /* keep poster visible */ } } catch (e) { }
            return;
          }
          try { v.currentTime = 0; v.play().catch(() => { }); } catch (e) { }
        }
      };
      v.addEventListener("timeupdate", v._previewTimeHandler);
      gsap.fromTo(v, { opacity: 0 }, { opacity: 1, duration: 0.28 });
      v.play().catch(() => { });
    } catch (e) { }
  };

  const startIdleTimer = () => {
    if (scope === "main") {
      if (mainIdleTimer) clearTimeout(mainIdleTimer);
      mainIdleTimer = setTimeout(() => { if (!v._hasEndedPlaying) startPreview(); mainIdleTimer = null; }, IDLE_TIMEOUT);
    } else {
      if (lightboxIdleTimer) clearTimeout(lightboxIdleTimer);
      lightboxIdleTimer = setTimeout(() => { if (!v._hasEndedPlaying) startPreview(); lightboxIdleTimer = null; }, IDLE_TIMEOUT);
    }
  };

  const poster = v.getAttribute("poster") || "";
  if (!poster) { startPreview(); } else {
    const img = new Image();
    img.onload = () => { startIdleTimer(); };
    img.onerror = () => { startPreview(); };
    img.src = poster;
  }

  v._stopPreviewAndIdle = () => {
    try { if (v._previewLoopActive) { v._previewLoopActive = false; v.removeEventListener("timeupdate", v._previewTimeHandler); v._previewTimeHandler = null; v.pause(); v.currentTime = 0; } } catch (e) { }
    if (scope === "main") { if (mainIdleTimer) { clearTimeout(mainIdleTimer); mainIdleTimer = null; } } else { if (lightboxIdleTimer) { clearTimeout(lightboxIdleTimer); lightboxIdleTimer = null; } }
  };
};

/* Vimeo idle preview with loop-count enforcement */
async function attachIdleLogicToVimeo(host, previewEl, scope) {
  clearVimeoIdle(scope);
  host._idleEnabled = true;

  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
  const meta = await fetchVimeoMeta(vimeoUrl) || { ratio: 16 / 9 };
  const ratio = meta.ratio || 16 / 9;

  const posterImg = host.querySelector('img');
  const waitPoster = new Promise((resolve) => {
    const src = posterImg && posterImg.getAttribute('src');
    if (!src) { resolve(); return; }
    const img = new Image(); let done = false;
    const t = setTimeout(() => { if (!done) { done = true; resolve(); } }, 600);
    img.onload = () => { if (!done) { done = true; clearTimeout(t); resolve(); } };
    img.onerror = () => { if (!done) { done = true; clearTimeout(t); resolve(); } };
    img.src = src;
  });
  await waitPoster;
  if (!document.body.contains(host) || !host._idleEnabled) return;

  const ref = { idleTimer: null, player: null, iframe: null, ro: null, loopCount: 0 };
  if (scope === "main") mainVimeoRef = ref; else lightboxVimeoRef = ref;

  ref.idleTimer = setTimeout(async () => {
    if (!document.body.contains(host) || !host._idleEnabled) return;
    const id = extractVimeoId(vimeoUrl);
    if (!id) return;
    const iframe = document.createElement('iframe');
    iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
    iframe.setAttribute('data-vimeo-iframe', '1');
    iframe.style.opacity = '0';
    iframe.style.border = '0';
    iframe.style.borderRadius = 'var(--border-radius)';

    const params = new URLSearchParams({ autoplay: 1, muted: 1, controls: 0, title: 0, byline: 0, portrait: 0, playsinline: 1, dnt: 1 });
    iframe.src = `https://player.vimeo.com/video/${id}?${params.toString()}`;

    if (!document.body.contains(host) || !host._idleEnabled) return;

    host.appendChild(iframe);

    const player = new Vimeo.Player(iframe);
    ref.player = player; ref.iframe = iframe;

    const fit = () => containIframeToBox(iframe, ratio);
    const ro = new ResizeObserver(fit);
    ro.observe(host);
    ref.ro = ro; setTimeout(fit, 0);

    let shown = false;
    player.on('timeupdate', async (data) => {
      if (!host._idleEnabled) { try { player.pause(); } catch (e) { } return; }
      if (!shown && data && typeof data.seconds === 'number') {
        shown = true;
        gsap.to(iframe, { opacity: 1, duration: 0.25 });
      }
      if (data && data.seconds >= PREVIEW_DURATION) {
        // count loops
        ref.loopCount = (ref.loopCount || 0) + 1;
        if (LOOP_LIMIT > 0 && ref.loopCount >= LOOP_LIMIT) {
          // fade to poster and stop
          try {
            await player.pause().catch(()=>{});
            if (iframe.parentElement) iframe.parentElement.removeChild(iframe);
            if (posterImg) { posterImg.style.opacity = '1'; }
          } catch (e) { }
          return;
        }
        player.setCurrentTime(0).catch(() => { });
      }
    });
    try { await player.setMuted(true); } catch (e) { }
    try { await player.play().catch(() => { }); } catch (e) { }

    host._stopVimeoPreviewAndIdle = () => {
      host._idleEnabled = false;
      try {
        if (ref.idleTimer) { clearTimeout(ref.idleTimer); ref.idleTimer = null; }
        if (ref.player) { ref.player.pause().catch(() => { }); }
        if (ref.ro) { try { ref.ro.disconnect(); } catch (e) { } }
        if (iframe && iframe.parentElement) { iframe.parentElement.removeChild(iframe); }
      } catch (e) { }
      if (scope === "main") mainVimeoRef = null; else lightboxVimeoRef = null;
    };
  }, IDLE_TIMEOUT);
}

/* contain helper for vimeo iframe */
function containIframeToBox(iframe, ratio) {
  const box = iframe.parentElement; if (!box) return;
  const w = box.clientWidth, h = box.clientHeight; if (!w || !h) return;
  const boxRatio = w / h;
  let targetW, targetH;
  if (ratio > boxRatio) { targetW = w; targetH = Math.round(w / ratio); }
  else { targetH = h; targetW = Math.round(h * ratio); }
  iframe.style.width = targetW + "px";
  iframe.style.height = targetH + "px";
  iframe.style.position = "absolute";
  iframe.style.top = "50%"; iframe.style.left = "50%";
  iframe.style.transform = "translate(-50%,-50%)";
}

/* -------------------------
   Build host elements (images, local video, vimeo)
   ------------------------- */

/* apply host-level play button variables for main vs lightbox */
function applyHostPlayVars(host, scope) {
  const s = CONFIG.styles.playButton;
  if (scope === "lightbox") {
    host.style.setProperty('--play-btn-size-d', s.lightbox.btnDesktop + 'px');
    host.style.setProperty('--play-btn-size-m', s.lightbox.btnMobile + 'px');
    host.style.setProperty('--play-circle-size-d', s.lightbox.circleDesktop + 'px');
    host.style.setProperty('--play-circle-size-m', s.lightbox.circleMobile + 'px');
    host.style.setProperty('--play-icon-size', s.lightbox.iconSize);
  } else {
    host.style.setProperty('--play-btn-size-d', s.main.btnDesktop + 'px');
    host.style.setProperty('--play-btn-size-m', s.main.btnMobile + 'px');
    host.style.setProperty('--play-circle-size-d', s.main.circleDesktop + 'px');
    host.style.setProperty('--play-circle-size-m', s.main.circleMobile + 'px');
    host.style.setProperty('--play-icon-size', s.main.iconSize);
  }
}

/* helper to make play overlay node */
function buildPlayOverlay(onClick) {
  const overlay = document.createElement('div');
  overlay.className = 'play-btn';
  overlay.innerHTML = '<span class="circle"><i class="fa-solid fa-play"></i></span>';
  overlay.style.transform = 'translate(-50%,-50%) scale(.6)';
  overlay.style.opacity = '0';
  overlay.addEventListener('click', (e) => { e.stopPropagation(); onClick(overlay); });
  return overlay;
}

/* Reusable out-animation that ensures animation plays before mounting Vimeo iframe */
function animateOverlayOutThen(overlayEl, cb) {
  if (!overlayEl) { try { cb(); } catch (e) { } return; }
  gsap.to(overlayEl, {
    scale: 1.6, opacity: 0, duration: .35, ease: "power2.out",
    onStart: () => { overlayEl.style.pointerEvents = "none"; },
    onComplete: () => { try { overlayEl.remove(); } catch (e) { } try { cb(); } catch (e) { } }
  });
}

/* Create media-host for images (lightbox needs to size to actual image ratio) */
function createImageHost(previewEl, scope) {
  const host = document.createElement('div');
  host.className = 'media-host';
  host.style.background = 'transparent';
  host.style.borderRadius = 'var(--border-radius)';
  applyHostPlayVars(host, scope);

  const img = document.createElement('img');
  img.alt = previewEl.dataset.alt || 'Image';
  img.style.maxWidth = '100%';
  img.style.maxHeight = '100%';
  img.style.display = 'block';
  img.style.borderRadius = 'var(--border-radius)';
  img.src = (previewEl.querySelector('img') && previewEl.querySelector('img').src) || previewEl.dataset.poster || VIMEO_PLACEHOLDER;

  host.appendChild(img);

  // when natural size known, size host to image ratio (so frame is precisely that ratio)
  img.addEventListener('load', () => {
    const naturalW = img.naturalWidth || 16;
    const naturalH = img.naturalHeight || 9;
    const ratio = naturalW / naturalH;
    attachResponsiveSizer(imgBox, host, () => ratio);
  });

  // Clicking on image should not close; overlay not needed for still images
  return host;
}

/* Create local video host (main & lightbox) */
function createLocalVideoHost(srcNodeOrUrl, scope, posterFallback, animateOverlay = true, alt = '') {
  const host = document.createElement('div');
  host.className = 'media-host';
  host.style.background = 'transparent';
  host.style.borderRadius = 'var(--border-radius)';
  applyHostPlayVars(host, scope);

  const v = document.createElement('video');
  v.controls = false; v.preload = 'auto'; v.setAttribute('aria-label', alt || 'Video');
  v.poster = (isVideoTag(srcNodeOrUrl) ? (srcNodeOrUrl.getAttribute('poster') || posterFallback || '') : (posterFallback || ''));
  const s = document.createElement('source');
  s.src = isVideoTag(srcNodeOrUrl) ? (srcNodeOrUrl.getAttribute('src') || srcNodeOrUrl.src) : srcNodeOrUrl;
  v.appendChild(s);
  v.style.width = '100%'; v.style.height = '100%';
  v.style.objectFit = 'contain'; v.style.background = 'transparent'; v.style.borderRadius = 'var(--border-radius)';
  host.appendChild(v);

  if (scope === 'lightbox') {
    // show proxy poster so we can fade back when loops end
    const proxy = document.createElement('img');
    proxy.className = 'poster-proxy'; proxy.alt = alt || 'Video poster';
    proxy.src = v.poster || VIMEO_PLACEHOLDER;
    Object.assign(proxy.style, { position: 'absolute', inset: 0, width: '100%', height: '100%', objectFit: 'cover', objectPosition: 'center', borderRadius: 'var(--border-radius)' });
    host.appendChild(proxy);

    // size host to video's real ratio when metadata loaded
    let aspect = null;
    v.addEventListener('loadedmetadata', () => { aspect = (v.videoWidth && v.videoHeight) ? (v.videoWidth / v.videoHeight) : (16 / 9); attachResponsiveSizer(imgBox, host, () => aspect || (16 / 9)); });
    attachResponsiveSizer(imgBox, host, () => aspect || (16 / 9));
  }

  const overlay = buildPlayOverlay(() => playVideoOverlay(v, overlay));
  host.appendChild(overlay);
  try { v.load(); } catch (e) { }
  attachIdleLogicToVideo(v, currentIndex, scope);
  if (animateOverlay) animateOverlayIn(overlay);
  return host;
}

/* Create Vimeo host: overlay animates out first, then mounts iframe */
function createVimeoHost(previewEl, scope, animateOverlay = true, alt = '') {
  clearVimeoIdle(scope);
  const host = document.createElement('div');
  host.className = 'media-host vimeo-host';
  host.style.background = 'transparent';
  host.style.borderRadius = 'var(--border-radius)';
  applyHostPlayVars(host, scope);

  const posterImg = document.createElement('img');
  posterImg.alt = alt || 'Vimeo preview';
  posterImg.style.width = '100%'; posterImg.style.height = '100%';
  posterImg.style.borderRadius = 'var(--border-radius)';
  posterImg.style.objectPosition = 'center';
  posterImg.style.objectFit = (scope === 'lightbox') ? 'cover' : 'contain';
  host.appendChild(posterImg);

  (async () => {
    const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || '';
    let poster = previewEl.dataset.mainPoster || vimeoPosterCache.get(vimeoUrl);
    if (!poster) {
      poster = await resolveVimeoPosterForMain(previewEl);
      if (poster) { await preloadImage(poster); vimeoPosterCache.set(vimeoUrl, poster); previewEl.dataset.mainPoster = poster; }
    }
    if (poster) { posterImg.src = poster; }

    if (scope === 'lightbox') {
      const meta = await fetchVimeoMeta(vimeoUrl);
      const ratio = meta && meta.ratio ? meta.ratio : (16 / 9);
      attachResponsiveSizer(imgBox, host, () => ratio);
    }

    attachIdleLogicToVimeo(host, previewEl, scope);
  })();

  const overlay = buildPlayOverlay((overlayEl) => {
    host._idleEnabled = false;
    if (typeof host._stopVimeoPreviewAndIdle === "function") try { host._stopVimeoPreviewAndIdle(); } catch (e) { }

    // Animate overlay out _first_, then mount iframe/player
    animateOverlayOutThen(overlayEl, async () => {
      const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || '';
      const id = extractVimeoId(vimeoUrl);
      if (!id) return;
      const iframe = document.createElement('iframe');
      iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
      iframe.setAttribute('data-vimeo-iframe', '1');
      iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = '0';
      const params = new URLSearchParams({ autoplay: 1, muted: 0, title: 0, byline: 0, portrait: 0, playsinline: 1 });
      host.innerHTML = ''; host.appendChild(iframe);
      iframe.src = `https://player.vimeo.com/video/${id}?${params.toString()}`;
      try {
        const player = new Vimeo.Player(iframe);
        vimeoPlayerMap.set(iframe, player);
        await player.play().catch(() => { });
      } catch (e) { }
    });
  });

  host.appendChild(overlay);
  if (animateOverlay) animateOverlayIn(overlay);
  return host;
}

/* Create Vimeo mini (strip) with loop-limit enforcement and poster fallback */
async function buildVimeoMini(previewEl, alt = '') {
  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || '';
  const id = extractVimeoId(vimeoUrl);
  if (!id) return;

  previewEl.innerHTML = '';
  const mini = document.createElement('div'); mini.className = 'vimeo-mini';
  previewEl.appendChild(mini);

  const posterImg = document.createElement('img');
  posterImg.className = 'vimeo-mini-poster'; posterImg.alt = alt || 'Vimeo';
  posterImg.src = VIMEO_PLACEHOLDER; mini.appendChild(posterImg);

  const overlay = document.createElement('span');
  overlay.className = 'play-overlay';
  overlay.innerHTML = '<span class="circle"><i class="fa-solid fa-play"></i></span>';
  previewEl.appendChild(overlay);

  const meta = await fetchVimeoMeta(vimeoUrl);
  const ratio = meta && meta.ratio ? meta.ratio : (16 / 9);
  const thumb = meta && meta.thumb;
  if (thumb && await validateImageUrl(thumb, CONFIG.behavior.validationTimeouts.thumb)) { posterImg.src = thumb; }

  const params = new URLSearchParams({ autoplay: 1, muted: 1, controls: 0, loop: 0, title: 0, byline: 0, portrait: 0, dnt: 1, playsinline: 1 });
  const iframe = document.createElement('iframe');
  iframe.src = `https://player.vimeo.com/video/${id}?${params.toString()}`;
  iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
  iframe.setAttribute('tabindex', '-1');
  mini.appendChild(iframe);

  const player = new Vimeo.Player(iframe);
  const state = { loopCount: 0, posterHidden: false, ro: null };
  try {
    await player.ready();
    await player.setMuted(true);
    await player.setLoop(false);
    await player.setVolume(0);
    try { await player.setQuality(CONFIG.behavior.vimeoMiniQuality); } catch (e) { }
    await player.play().catch(() => { });
  } catch (e) { }

  player.on('timeupdate', (data) => {
    if (data) {
      if (!state.posterHidden && typeof data.seconds === 'number') {
        state.posterHidden = true;
        posterImg.style.opacity = '0';
      }
      if (data.seconds >= PREVIEW_DURATION) {
        state.loopCount = (state.loopCount || 0) + 1;
        if (LOOP_LIMIT > 0 && state.loopCount >= LOOP_LIMIT) {
          // stop and show poster
          player.pause().catch(()=>{});
          if (iframe.parentElement) iframe.parentElement.removeChild(iframe);
          posterImg.style.opacity = '1';
          return;
        }
        player.setCurrentTime(0).catch(() => { });
      }
    }
  });
  player.on('pause', () => { player.play().catch(()=>{}); });
  player.on('ended', () => { player.setCurrentTime(0).then(()=>player.play().catch(()=>{})).catch(()=>{}); });

  const fit = () => coverIframeToBox(iframe, ratio);
  const ro = new ResizeObserver(fit);
  ro.observe(mini); setTimeout(fit, 0);
  state.ro = ro;

  vimeoMiniMap.set(previewEl, { player, iframe, container: mini, posterEl: posterImg, ratio, ro, state });
}

/* cover helper */
function coverIframeToBox(iframe, ratio) {
  const box = iframe.parentElement; if (!box) return;
  const w = box.clientWidth, h = box.clientHeight; if (!w || !h) return;
  const boxRatio = w / h;
  let targetW, targetH;
  if (ratio > boxRatio) { targetH = h; targetW = Math.ceil(h * ratio); }
  else { targetW = w; targetH = Math.ceil(w / ratio); }
  iframe.style.width = targetW + "px";
  iframe.style.height = targetH + "px";
  iframe.style.position = "absolute";
  iframe.style.top = "50%"; iframe.style.left = "50%";
  iframe.style.transform = "translate(-50%,-50%)";
}

/* init mini players + local loops */
async function initVimeoStripMiniPlayers() {
  const vims = previews.filter(p => getPreviewType(p) === "vimeo");
  for (const p of vims) { await buildVimeoMini(p, p.dataset.alt || "Vimeo"); }
}
function initLocalStripLoops() {
  previews.forEach((p) => {
    if (getPreviewType(p) !== "video") return;
    const pv = p.querySelector("video");
    if (!pv) return;
    pv.muted = true; pv.playsInline = true; pv.loop = false; pv.preload = "auto";
    pv._loopCount = 0;
    const kick = () => { try { pv.currentTime = 0; pv.play().catch(() => { }); } catch (e) { } };
    pv.addEventListener("loadeddata", kick, { once: true });
    try { pv.load(); kick(); } catch (e) { }
    pv.addEventListener("timeupdate", () => {
      if (pv.currentTime >= PREVIEW_DURATION) {
        pv._loopCount = (pv._loopCount || 0) + 1;
        if (LOOP_LIMIT > 0 && pv._loopCount >= LOOP_LIMIT) {
          // stop and revert to poster
          try { pv.pause(); if (pv.parentElement) { const poster = pv.getAttribute('poster'); if (poster) { /* poster remains visible */ } } } catch (e) { }
          return;
        }
        try { pv.currentTime = 0; pv.play().catch(() => { }); } catch (e) { }
      }
    });
  });
}

/* ensure player keep-alive */
setInterval(() => { vimeoMiniMap.forEach(({ player }) => player && player.getPaused && player.getPaused().then(p => { if (p) player.play().catch(() => { }); }).catch(() => { })); }, 6000);
document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') { vimeoMiniMap.forEach(({ player }) => player && player.play && player.play().catch(() => { })); } });
window.addEventListener('focus', () => { vimeoMiniMap.forEach(({ player }) => player && player.play && player.play().catch(() => { })); });

/* -------------------------
   Transitions, main view & lightbox logic
   ------------------------- */

function scrollPreviewIntoView(idx, dur = 0.5) {
  const el = previews[idx];
  const target = el.offsetLeft - (previewContainer.clientWidth / 2 - el.clientWidth / 2);
  gsap.to(previewContainer, { scrollLeft: target, duration: dur, ease: "power2.inOut" });
}
function cloneForAnim(node) {
  const m = node.cloneNode(true);
  m.style.position = "absolute"; m.style.top = 0; m.style.left = 0; m.style.width = "100%"; m.style.height = "100%";
  m.style.objectFit = "cover"; m.style.borderRadius = "var(--border-radius)";
  if (isVideoTag(m)) { m.muted = true; m.playsInline = true; m.controls = false; try { m.pause(); m.currentTime = 0 } catch (e) { } }
  return m;
}
function visualCloneFor(previewEl) {
  const t = getPreviewType(previewEl);
  if (t === "vimeo") {
    const img = document.createElement("img");
    const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
    const resolved = previewEl.dataset.mainPoster || vimeoPosterCache.get(vimeoUrl) || VIMEO_PLACEHOLDER;
    img.src = resolved; img.alt = previewEl.dataset.alt || "Vimeo poster";
    img.style.width = "100%"; img.style.height = "100%"; img.style.objectFit = "cover"; img.style.borderRadius = "var(--border-radius)";
    return cloneForAnim(img);
  }
  const node = mediaOf(previewEl);
  if (!node) {
    const ph = document.createElement("img"); ph.src = VIMEO_PLACEHOLDER; return cloneForAnim(ph);
  }
  return cloneForAnim(node);
}

/* clean up vimeo players in a given container */
function destroyVimeoPlayersInNode(node) {
  destroyVimeoPlayersIn(node);
}

/* MAIN click handlers */
const handleMainClick = (e) => {
  const previewEl = previews[currentIndex];
  if (!previewEl) return;
  const type = getPreviewType(previewEl);
  if (type === "video") {
    const host = mainImageBox.querySelector(".media-host");
    if (!host) return;
    const videoEl = host.querySelector("video");
    const clickedPlayBtn = e.target.closest(".play-btn");
    if (clickedPlayBtn && videoEl) {
      e.stopPropagation();
      if (typeof videoEl._stopPreviewAndIdle === "function") try { videoEl._stopPreviewAndIdle(); } catch (err) { }
      playVideoOverlay(videoEl, clickedPlayBtn);
    }
    return;
  } else if (type === "vimeo") {
    const clickedPlayBtn = e.target.closest(".play-btn");
    if (clickedPlayBtn) { clickedPlayBtn.click(); return; }
    return;
  } else {
    openLightbox(currentIndex);
  }
};
mainImageBox.addEventListener('click', handleMainClick);

/* Lightbox: clicking outside actual media closes; clicks on actual media or in-button do not */
galleryViewer.addEventListener('click', (e) => {
  if (!galleryViewer.classList.contains('active')) return;

  // if user clicked on arrow or close or play button, don't close here â€” let handlers do their job
  if (e.target.closest('.arrows') || e.target.closest('.close') || e.target.closest('.play-btn')) {
    return;
  }

  // If the click target is an actual media element (img, video, iframe) inside imgBox -> do NOT close
  const clickedMedia = e.target.closest('img,video,iframe');
  if (clickedMedia && imgBox.contains(clickedMedia)) {
    // clicked on the actual media -> don't close
    return;
  }

  // If the click is inside imgBox but not on the actual media (that is, in the transparent frame) -> close
  if (e.target.closest('.imgBox')) {
    closeLightbox();
    return;
  }

  // Click outside imgBox -> close as well
  closeLightbox();
});

/* Prevent the arrow clicks from bubbling into galleryViewer click */
nextBtn.addEventListener('click', (e) => { e.stopPropagation(); if (isAnimating) return; currentIndex = (currentIndex + 1) % previews.length; slideAnimation(true); });
prevBtn.addEventListener('click', (e) => { e.stopPropagation(); if (isAnimating) return; currentIndex = (currentIndex - 1 + previews.length) % previews.length; slideAnimation(false); });
closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeLightbox(); });

/* Open/Close lightbox */
function openLightbox(index) {
  gsap.to(galleryViewer, {
    opacity: 1, duration: 0.3, onStart: () => {
      galleryViewer.classList.add('active');
      document.body.classList.add('no-scroll');
      currentIndex = index; startIndex = index; updateSlide(true);
    }
  });
}
function closeLightbox() {
  const lbVideo = imgBox.querySelector('video');
  if (lbVideo) {
    try {
      lbVideo.pause(); lbVideo.currentTime = 0; lbVideo.controls = false;
      if (lbVideo._previewLoopActive) { lbVideo._previewLoopActive = false; lbVideo.removeEventListener("timeupdate", lbVideo._previewTimeHandler); }
    } catch (e) { }
  }
  clearLightboxIdleAndPreview();
  clearVimeoIdle('lightbox');
  pauseVimeoIn(imgBox);
  destroyVimeoPlayersIn(imgBox);

  gsap.to(galleryViewer, {
    opacity: 0, duration: 0.3, onComplete: () => {
      galleryViewer.classList.remove('active');
      document.body.classList.remove('no-scroll');
      if (currentIndex !== startIndex) {
        const direction = currentIndex > startIndex ? 1 : -1;
        const steps = Math.abs(currentIndex - startIndex);
        const fromMedia = visualCloneFor(previews[startIndex]);
        const toMedia = visualCloneFor(previews[currentIndex]);
        const wrapper = mainImageBox;
        wrapper.style.position = 'relative'; wrapper.innerHTML = "";
        wrapper.appendChild(fromMedia); wrapper.appendChild(toMedia);
        gsap.set(toMedia, { x: direction > 0 ? "100%" : "-100%" });
        const targetPreview = previews[currentIndex];
        const targetScroll = targetPreview.offsetLeft - (previewContainer.clientWidth / 2 - targetPreview.clientWidth / 2);
        const tl = gsap.timeline({ onComplete: () => {
          wrapper.innerHTML = ""; setMainMedia(currentIndex);
          previews.forEach(p => p.classList.remove('active')); previews[currentIndex].classList.add('active');
        }});
        tl.addLabel('start')
          .to(fromMedia, { x: direction > 0 ? "-100%" : "100%", duration: 0.5, ease: "power2.inOut" }, "start")
          .to(toMedia, { x: "0%", duration: 0.5, ease: "power2.inOut" }, "start")
          .to(previewContainer, { scrollLeft: targetScroll, duration: 0.5, ease: "power2.inOut" }, "start")
          .to({}, { duration: 0.5, onUpdate: () => {
            const progress = tl.progress();
            const stepIndex = Math.round(startIndex + progress * steps * direction);
            if (previews[stepIndex]) { previews.forEach(p => p.classList.remove('active')); previews[stepIndex].classList.add('active'); }
          } }, "start");
      }
      cleanupLightboxHost();
    }
  });
}
function cleanupLightboxHost() {
  const old = imgBox.firstElementChild;
  if (!old) return;
  if (old._ro) { try { old._ro.disconnect(); } catch (e) { } }
  if (old._onResize) { window.removeEventListener('resize', old._onResize); }
}

/* Update slide (create host sized to media ratio) */
function updateSlide(animateIn = false) {
  cleanupLightboxHost();
  destroyVimeoPlayersIn(imgBox);
  imgBox.innerHTML = '';
  const previewEl = previews[currentIndex];
  if (!previewEl) return;
  const type = getPreviewType(previewEl);
  let hostOrNode;

  if (type === "video") {
    const node = mediaOf(previewEl);
    hostOrNode = createLocalVideoHost(node, 'lightbox', node?.getAttribute('poster') || '', false, previewEl.dataset.alt || 'Video');
  } else if (type === "vimeo") {
    hostOrNode = createVimeoHost(previewEl, 'lightbox', false, previewEl.dataset.alt || 'Vimeo video');
  } else {
    // image host auto-scales to actual image ratio
    hostOrNode = createImageHost(previewEl, 'lightbox');
    clearLightboxIdleAndPreview();
    clearVimeoIdle('lightbox');
  }
  imgBox.appendChild(hostOrNode);

  if (animateIn) {
    const overlay = imgBox.querySelector('.play-btn');
    if (overlay) animateOverlayIn(overlay);
  }
  return hostOrNode;
}

/* slide animations */
function nextSlide() { if (isAnimating) return; currentIndex = (currentIndex + 1) % previews.length; slideAnimation(true); }
function prevSlide() { if (isAnimating) return; currentIndex = (currentIndex - 1 + previews.length) % previews.length; slideAnimation(false); }
function slideAnimation(isNext) {
  isAnimating = true;
  clearLightboxIdleAndPreview();
  clearVimeoIdle('lightbox');
  pauseVimeoIn(imgBox);
  destroyVimeoPlayersIn(imgBox);
  const media = updateSlide(false);
  gsap.fromTo(media, { opacity: 0, x: isNext ? "100%" : "-100%" }, { opacity: 1, x: "0%", duration: 0.5, ease: "power2.out", onComplete: () => {
    isAnimating = false;
    const overlay = imgBox.querySelector('.play-btn');
    if (overlay) animateOverlayIn(overlay);
  }});
}

/* Play overlay for local video */
function playVideoOverlay(videoEl, overlayEl) {
  if (!videoEl) return;
  try {
    if (typeof videoEl._stopPreviewAndIdle === "function") try { videoEl._stopPreviewAndIdle(); } catch (err) { }
    if (videoEl._previewLoopActive) {
      try { videoEl._previewLoopActive = false; videoEl.removeEventListener("timeupdate", videoEl._previewTimeHandler); videoEl._previewTimeHandler = null; } catch (e) { }
    }
    try { videoEl.currentTime = 0; } catch (e) { }
    gsap.to(overlayEl, {
      scale: 1.6, opacity: 0, duration: .35, ease: "power2.out",
      onStart: () => { overlayEl.style.pointerEvents = "none"; },
      onComplete: () => {
        try { overlayEl.remove(); } catch (e) { }
        const proxy = videoEl.parentElement && videoEl.parentElement.querySelector('.poster-proxy');
        if (proxy) { try { proxy.remove(); } catch (e) { } }
        videoEl.controls = true; videoEl.muted = false;
        try { videoEl.play().catch(() => { }); } catch (e) { }
      }
    });
  } catch (e) { }
}

/* -------------------------
   Preview strip building & wiring
   ------------------------- */

/* create preview DOM from item data */
function createPreviewFromItem(item) {
  const p = document.createElement('div');
  p.className = 'preview';
  p.dataset.type = item.type;
  p.dataset.alt = item.alt || '';
  if (item.type === 'image') {
    const img = document.createElement('img');
    img.src = (item.thumbValid ? item.thumb : item.src);
    img.alt = item.alt || 'Image';
    p.appendChild(img);
  } else if (item.type === 'video') {
    const vid = document.createElement('video');
    vid.src = item.src;
    if (item.posterValid && item.poster) vid.setAttribute('poster', item.poster);
    vid.muted = true; vid.playsInline = true; vid.preload = 'auto';
    vid.setAttribute('aria-label', item.alt || 'Video');
    p.appendChild(vid);
    const overlay = document.createElement('span'); overlay.className = 'play-overlay'; overlay.innerHTML = '<span class="circle"><i class="fa-solid fa-play"></i></span>';
    p.appendChild(overlay);
  } else if (item.type === 'vimeo') {
    p.dataset.src = item.src;
    if (item.posterValid && item.poster) p.dataset.poster = item.poster;
    if (item._metaResolved) p.dataset._metaResolved = "1";
  }
  return p;
}

/* wire preview clicks (transitions) */
function wirePreviewClicks() {
  previews.forEach((preview, index) => {
    preview.addEventListener('click', () => {
      if (index === currentIndex) { scrollPreviewIntoView(index, 0.35); return; }
      const direction = index > currentIndex ? 1 : -1;

      destroyVimeoPlayersIn(mainImageBox);
      clearVimeoIdle('main');

      const live = mainImageBox.firstElementChild;
      const wrapper = document.createElement('div');
      Object.assign(wrapper.style, { position: 'relative', width: '100%', height: '100%', borderRadius: 'var(--border-radius)', overflow: 'hidden', pointerEvents: 'none' });
      if (live) {
        mainImageBox.appendChild(wrapper);
        live.style.position = 'absolute'; live.style.top = '0'; live.style.left = '0'; live.style.width = '100%'; live.style.height = '100%';
        wrapper.appendChild(live);
      } else mainImageBox.appendChild(wrapper);

      const toMedia = visualCloneFor(preview);
      wrapper.appendChild(toMedia);
      gsap.set(toMedia, { x: direction > 0 ? "100%" : "-100%" });

      const steps = Math.abs(index - currentIndex);
      const tl = gsap.timeline({ onComplete: () => {
        mainImageBox.innerHTML = "";
        setMainMedia(index);
        previews.forEach(p => p.classList.remove('active'));
        preview.classList.add('active');
        currentIndex = index;
      } });

      tl.addLabel('start');
      if (live) tl.to(live, { x: direction > 0 ? "-100%" : "100%", duration: 0.5, ease: "power2.inOut" }, "start");
      tl.to(toMedia, { x: "0%", duration: 0.5, ease: "power2.inOut" }, "start")
        .to(previewContainer, { scrollLeft: preview.offsetLeft - (previewContainer.clientWidth / 2 - preview.clientWidth / 2), duration: 0.5, ease: "power2.inOut" }, "start")
        .to({}, { duration: 0.3, onUpdate: function () {
          const progress = this.progress();
          const stepIndex = Math.round(currentIndex + progress * steps * direction);
          if (previews[stepIndex]) { previews.forEach(p => p.classList.remove('active')); previews[stepIndex].classList.add('active'); }
        } }, "start");
    });
  });
}

/* -------------------------
   Vimeo poster resolution & background recovery
   ------------------------- */

async function resolveVimeoPosterForMain(previewEl) {
  const localPoster = previewEl.dataset.poster || "";
  if (localPoster) {
    const valid = await validateImageUrl(localPoster, CONFIG.behavior.validationTimeouts.poster);
    if (valid) return localPoster;
  }
  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
  const meta = await fetchVimeoMeta(vimeoUrl);
  const thumb = meta && meta.thumb;
  if (thumb && await validateImageUrl(thumb, 3500)) return thumb;
  return VIMEO_PLACEHOLDER;
}

async function attemptVimeoMetaRecovery(previewEl, attemptsLeft = CONFIG.behavior.vimeoMetaRetryAttempts) {
  if (!previewEl || !previewEl.dataset.src) return;
  const url = previewEl.dataset.src;
  const meta = await fetchVimeoMeta(url);
  if (meta) {
    vimeoMetaCache.set(url, meta);
    if (meta.thumb) { vimeoPosterCache.set(url, meta.thumb); previewEl.dataset._metaResolved = "1"; previewEl.dataset._ratio = meta.ratio; }
    const mini = previewEl.querySelector('.vimeo-mini');
    if (mini) {
      const posterImg = mini.querySelector('img.vimeo-mini-poster');
      if (posterImg && meta.thumb) { posterImg.src = meta.thumb; }
      const iframe = mini.querySelector('iframe');
      if (iframe) { const fit = () => coverIframeToBox(iframe, meta.ratio); const ro = new ResizeObserver(fit); ro.observe(mini); setTimeout(fit, 0); }
    }
    if (previewEl === previews[currentIndex]) {
      const mainHost = mainImageBox.querySelector('.media-host.vimeo-host');
      if (mainHost) {
        const img = mainHost.querySelector('img');
        if (img && meta.thumb) img.src = meta.thumb;
      }
    }
  } else {
    if (attemptsLeft > 0) {
      setTimeout(() => attemptVimeoMetaRecovery(previewEl, attemptsLeft - 1), CONFIG.behavior.vimeoMetaRetryDelay);
    }
  }
}

/* -------------------------
   Main view set & boot sequence
   ------------------------- */

function setMainMedia(index) {
  const previewEl = previews[index];
  if (!previewEl) return;
  const type = getPreviewType(previewEl);
  const srcNode = mediaOf(previewEl);

  destroyVimeoPlayersIn(mainImageBox);
  clearVimeoIdle('main');

  mainImageBox.innerHTML = '';
  if (type === "video" && srcNode) {
    mainImageBox.style.background = "black";
    const alt = previewEl.dataset.alt || 'Video';
    mainImageBox.appendChild(createLocalVideoHost(srcNode, 'main', srcNode?.getAttribute('poster') || '', true, alt));
    clearVimeoIdle('main');
  } else if (type === "vimeo") {
    mainImageBox.style.background = "black";
    const alt = previewEl.dataset.alt || 'Vimeo video';
    const host = createVimeoHost(previewEl, 'main', true, alt);
    mainImageBox.appendChild(host);
    clearMainIdleAndPreview();
  } else {
    mainImageBox.style.background = "#ddd";
    const img = srcNode ? srcNode.cloneNode(true) : document.createElement('img');
    img.alt = previewEl.dataset.alt || 'Image';
    if (!srcNode) { img.src = VIMEO_PLACEHOLDER; }
    img.style.width = "100%"; img.style.height = "100%"; img.style.objectFit = "cover"; img.style.borderRadius = "var(--border-radius)";
    mainImageBox.appendChild(img);
    clearMainIdleAndPreview(); clearVimeoIdle('main');
  }
}

/* Validate items (Vimeo accepted if ID valid even if meta fetch fails) */
async function validateItem(item) {
  const t = (item.type || 'image').toLowerCase();
  if (t === 'image') {
    const ok = await validateImageUrl(item.src, CONFIG.behavior.validationTimeouts.image);
    if (!ok) return null;
    const thumbValid = item.thumb ? await validateImageUrl(item.thumb, CONFIG.behavior.validationTimeouts.thumb) : false;
    return { ...item, type: 'image', thumbValid };
  }
  if (t === 'video') {
    const ok = await validateVideoUrl(item.src, CONFIG.behavior.validationTimeouts.video);
    if (!ok) return null;
    const posterValid = item.poster ? await validateImageUrl(item.poster, CONFIG.behavior.validationTimeouts.poster) : false;
    return { ...item, type: 'video', posterValid, thumbValid: false };
  }
  if (t === 'vimeo') {
    const id = extractVimeoId(item.src || '');
    if (!id) return null;
    const meta = await fetchVimeoMeta(item.src);
    const posterValid = item.poster ? await validateImageUrl(item.poster, CONFIG.behavior.validationTimeouts.poster) : false;
    if (meta) {
      if (meta.thumb) vimeoPosterCache.set(item.src, meta.thumb);
      vimeoMetaCache.set(item.src, meta);
      return { ...item, type: 'vimeo', posterValid, _ratio: meta.ratio, _metaResolved: true };
    } else {
      return { ...item, type: 'vimeo', posterValid, _ratio: 16 / 9, _metaResolved: false, _metaMissing: true };
    }
  }
  return null;
}

/* Boot sequence: fast skeleton + progressive replace from JSON */
async function boot() {
  previewContainer.innerHTML = '';
  const skeletonSlots = GALLERY_DATA.map(() => {
    const s = document.createElement('div'); s.className = 'preview skeleton'; return s;
  });
  skeletonSlots.forEach(s => previewContainer.appendChild(s));

  const tasks = GALLERY_DATA.map((item, idx) => validateItem(item).then(res => ({ idx, res })).catch(() => ({ idx, res: null })));
  let firstMainSet = false;

  for (const t of tasks) {
    t.then(({ idx, res }) => {
      const slot = previewContainer.children[idx];
      if (res) {
        const newPrev = createPreviewFromItem(res);
        previews[idx] = newPrev;
        if (slot) previewContainer.replaceChild(newPrev, slot); else previewContainer.appendChild(newPrev);
        if (res.type === 'vimeo' && res._metaMissing) {
          setTimeout(() => attemptVimeoMetaRecovery(newPrev), CONFIG.behavior.vimeoMetaRetryDelay);
        }
        if (!firstMainSet) {
          firstMainSet = true; currentIndex = idx; newPrev.classList.add('active'); setMainMedia(idx);
        }
        const validCount = Array.from(previewContainer.children).filter(c => !c.classList.contains('skeleton')).length;
        if (validCount >= 2) { previewContainer.classList.add('visible'); previewContainer.classList.remove('hidden'); }
      } else {
        if (slot && slot.parentElement) slot.parentElement.removeChild(slot);
        previews[idx] = undefined;
      }
    });
  }

  Promise.allSettled(tasks).then(async () => {
    previews = Array.from(previewContainer.children);
    if (previews.length <= 1) {
      previewContainer.classList.remove('visible'); previewContainer.classList.add('hidden');
    } else {
      previewContainer.classList.remove('hidden'); previewContainer.classList.add('visible');
    }
    wirePreviewClicks();
    const startVimeoMinis = () => initVimeoStripMiniPlayers().then(() => initLocalStripLoops());
    if ('requestIdleCallback' in window) requestIdleCallback(startVimeoMinis, { timeout: 500 }); else setTimeout(startVimeoMinis, 0);
    previews.forEach(p => {
      if (getPreviewType(p) === 'vimeo' && p.dataset._metaResolved !== '1') {
        attemptVimeoMetaRecovery(p);
      }
    });
  });
}

/* utility used inside vimeo host builder */
async function resolveVimeoPosterForMain(previewEl) {
  const localPoster = previewEl.dataset.poster || "";
  if (localPoster) {
    const valid = await validateImageUrl(localPoster, CONFIG.behavior.validationTimeouts.poster);
    if (valid) return localPoster;
  }
  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
  const meta = await fetchVimeoMeta(vimeoUrl);
  const thumb = meta && meta.thumb;
  if (thumb && await validateImageUrl(thumb, 3500)) return thumb;
  return VIMEO_PLACEHOLDER;
}

/* Vimeo pause helper for container */
function pauseVimeoIn(container) {
  const iframe = container.querySelector("iframe[data-vimeo-iframe='1']");
  if (!iframe) return;
  const player = vimeoPlayerMap.get(iframe);
  if (player) { try { player.pause(); } catch (e) { } }
}

/* Clear vimeo idle ref */
function clearVimeoIdle(scope) {
  const ref = (scope === "main") ? mainVimeoRef : lightboxVimeoRef;
  if (!ref) return;
  try {
    if (ref.idleTimer) clearTimeout(ref.idleTimer);
    if (ref.player) { ref.player.pause().catch(() => { }); }
    if (ref.ro) { try { ref.ro.disconnect(); } catch (e) { } }
    if (ref.iframe && ref.iframe.parentElement) { ref.iframe.parentElement.removeChild(ref.iframe); }
  } catch (e) { }
  if (scope === "main") mainVimeoRef = null; else lightboxVimeoRef = null;
}

/* -------------------------
   Keyboard and touch
   ------------------------- */
document.addEventListener('keydown', (e) => {
  const active = document.activeElement;
  if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA" || active.isContentEditable)) return;
  if (e.key === "Escape") { if (galleryViewer.classList.contains('active')) closeLightbox(); return; }
  if (e.code === "Space") {
    e.preventDefault();
    if (galleryViewer.classList.contains('active')) {
      const overlay = imgBox.querySelector('.play-btn');
      const v = imgBox.querySelector('video');
      const vf = imgBox.querySelector("iframe[data-vimeo-iframe='1']");
      if (overlay && (v || getPreviewType(previews[currentIndex]) === "vimeo")) { overlay.click(); }
      else if (v) { if (v.paused) v.play().catch(() => { }); else v.pause(); }
      else if (vf) { const player = vimeoPlayerMap.get(vf); if (player) { player.getPaused().then(paused => paused ? player.play() : player.pause()).catch(() => { }); } }
    } else {
      const overlay = mainImageBox.querySelector('.play-btn');
      const v = mainImageBox.querySelector('video');
      const vf = mainImageBox.querySelector("iframe[data-vimeo-iframe='1']");
      const isVimeo = (getPreviewType(previews[currentIndex]) === "vimeo");
      if (overlay && (v || isVimeo)) { overlay.click(); }
      else if (v) { if (v.paused) v.play().catch(() => { }); else v.pause(); }
      else if (vf) { const player = vimeoPlayerMap.get(vf); if (player) { player.getPaused().then(paused => paused ? player.play() : player.pause()).catch(() => { }); } }
    }
    return;
  }
  if (e.key === "ArrowRight") { if (galleryViewer.classList.contains('active')) nextSlide(); return; }
  if (e.key === "ArrowLeft") { if (galleryViewer.classList.contains('active')) prevSlide(); return; }
});

/* touch swipe */
let touchStartX = 0;
galleryViewer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; });
galleryViewer.addEventListener('touchend', (e) => { const diff = e.changedTouches[0].screenX - touchStartX; if (Math.abs(diff) > 50) { if (diff > 0) prevSlide(); else nextSlide(); } });

/* -------------------------
   Start
   ------------------------- */
window.addEventListener('load', boot);

</script>
</body>
</html>
