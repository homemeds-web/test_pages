<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog Media Gallery — Updated (Vimeo poster + preload fixes)</title>

  <!-- speed: preconnect to Vimeo hosts so first-time visitors load metadata faster -->
  <link rel="preconnect" href="https://player.vimeo.com" crossorigin />
  <link rel="preconnect" href="https://vimeo.com" crossorigin />
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://player.vimeo.com/api/player.js"></script>

  <style>
    :root{
      --border-radius:12px;--gap-size:0.5rem;--main-aspect-ratio:16/9;--lightbox-padding:1rem;
      --preview-size-d:65px;--preview-size-m:55px;--preview-border-width:4px;
      --preview-border-active:#0073e6;--preview-border-inactive:transparent;
      --preview-play-circle-size-d:34px;--preview-play-circle-size-m:30px;--preview-play-icon-size:1.1rem;
      --play-btn-size-d:96px;--play-btn-size-m:78px;--play-circle-size-d:66px;--play-circle-size-m:56px;--play-icon-size:1.4rem;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;padding:2rem;background:#fafafa;}
    .no-scroll{overflow:hidden;}
    .blog-image{max-width:800px;width:100%;aspect-ratio:var(--main-aspect-ratio);border-radius:var(--border-radius);box-shadow:0 4px 15px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:var(--gap-size);background:#ddd;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center;}
    .blog-image img{display:block;width:100%;height:100%;object-fit:cover;border-radius:var(--border-radius);}
    .blog-image .video-host{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:transparent;border-radius:var(--border-radius);overflow:hidden;position:relative;}
    .blog-image .video-host video{display:block;width:100%;height:100%;background:transparent;border-radius:var(--border-radius);object-fit:contain;}
    .blog-image .video-host iframe{display:block;border:0;border-radius:var(--border-radius);background:transparent;}
    .skeleton{position:relative; background: #eaeaea; }
    .skeleton::after{content:""; position:absolute; inset:0;background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); transform: translateX(-100%); animation: shimmer 1.2s infinite;}
    @keyframes shimmer{ 100% { transform: translateX(100%); } }

    .previews{display:flex;gap:var(--gap-size);overflow-x:auto;max-width:800px;width:100%;padding-bottom:0.5rem;visibility:hidden;}
    .previews.visible{visibility:visible;}
    .previews.hidden{display:none;}
    .preview{flex:0 0 auto;width:var(--preview-size-d);height:var(--preview-size-d);border-radius:var(--border-radius);overflow:hidden;cursor:pointer;border:var(--preview-border-width) solid var(--preview-border-inactive);transition:transform .3s ease,border .3s ease;position:relative;background:#e5e5e5;}
    .preview img,.preview video{width:100%;height:100%;object-fit:cover;display:block;border-radius:calc(var(--border-radius) - 2px);}
    .preview .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;font-size:var(--preview-play-icon-size);color:rgba(255,255,255,.95);text-shadow:0 2px 6px rgba(0,0,0,.5);z-index:5;}
    .preview .play-overlay .circle{width:var(--preview-play-circle-size-d);height:var(--preview-play-circle-size-d);border-radius:50%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;}
    .preview.active{border-color:var(--preview-border-active);transform:scale(.9);}

    .play-btn{position:absolute;left:50%;top:50%;width:var(--play-btn-size-d);height:var(--play-btn-size-d);border-radius:50%;display:flex;align-items:center;justify-content:center;pointer-events:auto;transform:translate(-50%,-50%) scale(.6);opacity:0;transform-origin:center;z-index:3;}
    .play-btn .circle{width:var(--play-circle-size-d);height:var(--play-circle-size-d);border-radius:50%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;color:#fff;font-size:var(--play-icon-size);}

    .galleryViewer{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;opacity:0;z-index:9999;}
    .galleryViewer.active{display:flex;}
    .galleryViewer .imgBox{max-width:95%;max-height:calc(100% - (var(--lightbox-padding)*2 + 45px + 45px));height:calc(100% - (var(--lightbox-padding)*2 + 45px + 45px));width:95%;display:flex;justify-content:center;align-items:center;position:relative;background:transparent;border-radius:var(--border-radius);overflow:visible;}
    .galleryViewer .imgBox .media-host{display:flex;align-items:center;justify-content:center;background:transparent;border-radius:var(--border-radius);overflow:hidden;position:relative;}
    .galleryViewer .imgBox video,.galleryViewer .imgBox iframe{max-width:100%;max-height:100%;border:0;border-radius:var(--border-radius);background:transparent;}
    .galleryViewer .imgBox img{max-width:100%;max-height:100%;object-fit:contain;border-radius:var(--border-radius);}
    .galleryViewer .arrows{position:absolute;bottom:var(--lightbox-padding);left:0;width:100%;display:flex;justify-content:space-between;padding:0 1rem;pointer-events: none;}
    .galleryViewer .arrows span{pointer-events:auto;background:white;font-size:1.2rem;width:45px;height:45px;display:flex;justify-content:center;align-items:center;border-radius:50%;cursor:pointer;transition:300ms ease;}
    .galleryViewer .arrows span:hover{background:rgba(255,255,255,.7);}
    .galleryViewer .close{width:45px;height:45px;background:red;display:flex;justify-content:center;align-items:center;color:white;cursor:pointer;position:absolute;top:var(--lightbox-padding);right:var(--lightbox-padding);border-radius:50%;pointer-events:auto;}
    .galleryViewer .close:hover{background:rgba(255,0,0,.7);}

    .preview .vimeo-mini{position:relative;width:100%;height:100%;overflow:hidden;border-radius:calc(var(--border-radius) - 2px);background:#000;}
    .preview .vimeo-mini iframe{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:0;pointer-events:none;border-radius:inherit;background:transparent;}
    .preview .vimeo-mini img.vimeo-mini-poster{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;border-radius:inherit;transition:opacity .25s ease;z-index:1;}

    @media(max-width:768px){body{padding:.5rem}.preview{width:var(--preview-size-m);height:var(--preview-size-m)}.play-btn{width:var(--play-btn-size-m);height:var(--play-btn-size-m)}.play-btn .circle{width:var(--play-circle-size-m);height:var(--play-circle-size-m)}.preview .play-overlay .circle{width:var(--preview-play-circle-size-m);height:var(--preview-play-circle-size-m)}}
  </style>
</head>
<body>

  <!-- Main Media container -->
  <div class="blog-image" id="mainImageBox" aria-label="Main media">
    <div class="skeleton" style="width:100%;height:100%;border-radius:var(--border-radius);"></div>
  </div>

  <!-- Previews -->
  <div class="previews" id="previewContainer" aria-label="Media previews"></div>

  <!-- Lightbox -->
  <div class="galleryViewer" id="galleryViewer" aria-modal="true" role="dialog">
    <div class="imgBox"></div>
    <div class="arrows"><span class="prev" aria-label="Previous"><i class="fa-solid fa-arrow-left"></i></span><span class="next" aria-label="Next"><i class="fa-solid fa-arrow-right"></i></span></div>
    <div class="close" aria-label="Close"><i class="fa-solid fa-xmark"></i></div>
  </div>

<script>
/* ============================
   CONFIG & gallery JSON
   ============================ */
const CONFIG = {
  styles: {
    borderRadius: 12, gap: 8, mainAspectRatio: "16/9",
    preview: { sizeDesktop: 65, sizeMobile: 55, borderWidth: 4, activeBorder: "#0073e6", inactiveBorder: "transparent" },
    playButton: {
      preview: { circleDesktop: 34, circleMobile: 30, iconSize: "1.1rem" },
      main:    { btnDesktop: 96, btnMobile: 78, circleDesktop: 66, circleMobile: 56, iconSize: "1.4rem" },
      lightbox:{ btnDesktop: 96, btnMobile: 78, circleDesktop: 66, circleMobile: 56, iconSize: "1.4rem" }
    },
    lightboxPadding: "1rem"
  },
  behavior: {
    idleTimeoutMs: 10000,
    previewLoopSeconds: 5,
    vimeoMiniQuality: "240p",
    validationTimeouts: { image: 1100, thumb: 900, poster: 900, video: 1300, vimeoOembed: 1500 },
    vimeoMetaRetryDelay: 3000,
    vimeoMetaRetryAttempts: 2,
    // loopLimits: 0 => infinite, >0 => number of cycles allowed before fallback to poster
    loopLimits: { preview: 0, main: 0, lightbox: 0 }
  }
};

/* Sample gallery in JSON form (editable). Note the Vimeo item includes the local poster you specified. */
const GALLERY_DATA = [
  { type: "image", src: "media/image1.jpg", alt: "Sunlight over ridge" },
  { type: "image", src: "media/image2.jpg", alt: "Forest path" },
  { type: "image", src: "media/image3.jpg", alt: "City skyline" },
  { type: "video", src: "media/video2.mp4", poster: "media/image.jpg", alt: "Local surfing clip" },
  /* Vimeo item - local poster specified as requested */
  { type: "vimeo", src: "https://vimeo.com/1112464020", poster: "media/imag7.jpg", alt: "Vimeo: city timelapse" },
  { type: "image", src: "media/image4.jpg", alt: "Lake reflection" }
];

/* Apply CSS variables from CONFIG quickly */
(function applyStyleVars(cfg){
  const r = document.documentElement.style;
  const s = cfg.styles;
  r.setProperty('--border-radius', s.borderRadius + 'px');
  r.setProperty('--gap-size', s.gap + 'px');
  r.setProperty('--main-aspect-ratio', s.mainAspectRatio);
  r.setProperty('--lightbox-padding', s.lightboxPadding);

  r.setProperty('--preview-size-d', s.preview.sizeDesktop + 'px');
  r.setProperty('--preview-size-m', s.preview.sizeMobile + 'px');
  r.setProperty('--preview-border-width', s.preview.borderWidth + 'px');
  r.setProperty('--preview-border-active', s.preview.activeBorder);
  r.setProperty('--preview-border-inactive', s.preview.inactiveBorder);

  r.setProperty('--preview-play-circle-size-d', s.playButton.preview.circleDesktop + 'px');
  r.setProperty('--preview-play-circle-size-m', s.playButton.preview.circleMobile + 'px');
  r.setProperty('--preview-play-icon-size', s.playButton.preview.iconSize);

  r.setProperty('--play-btn-size-d', s.playButton.main.btnDesktop + 'px');
  r.setProperty('--play-btn-size-m', s.playButton.main.btnMobile + 'px');
  r.setProperty('--play-circle-size-d', s.playButton.main.circleDesktop + 'px');
  r.setProperty('--play-circle-size-m', s.playButton.main.circleMobile + 'px');
  r.setProperty('--play-icon-size', s.playButton.main.iconSize);
})(CONFIG);

/* ============================
   DOM refs + state
   ============================ */
const mainImageBox=document.getElementById("mainImageBox");
const previewContainer=document.getElementById("previewContainer");
const galleryViewer=document.getElementById("galleryViewer");
const imgBox=galleryViewer.querySelector(".imgBox");
const nextBtn=galleryViewer.querySelector(".next");
const prevBtn=galleryViewer.querySelector(".prev");
const closeBtn=galleryViewer.querySelector(".close");

let previews = [];
let currentIndex=0,isAnimating=false,startIndex=0;
let mainIdleTimer=null, mainVideoEl=null, lightboxIdleTimer=null, lightboxVideoEl=null;
let mainVimeoRef=null, lightboxVimeoRef=null;

const IDLE_TIMEOUT=CONFIG.behavior.idleTimeoutMs, PREVIEW_DURATION=CONFIG.behavior.previewLoopSeconds;
const vimeoMetaCache = new Map();
const vimeoPosterCache = new Map();
const vimeoPlayerMap = new Map();
const vimeoMiniMap   = new Map();
const VIMEO_PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 675"><rect width="1200" height="675" fill="#111"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#666" font-family="Arial" font-size="42">Loading…</text></svg>`);

/* ============================
   Utility & network helpers
   ============================ */
const isVideo=(el)=>el&&el.tagName&&el.tagName.toLowerCase()==="video";
const mediaOf=(previewEl)=>previewEl&&previewEl.querySelector?previewEl.querySelector("img,video"):null;
const getPreviewType=(p)=> (p && p.dataset && (p.dataset.type||"image")).toLowerCase();

function withTimeoutPromise(promise, ms){
  return new Promise((resolve,reject)=>{
    let done=false;
    const t=setTimeout(()=>{ if(!done){ done=true; reject(new Error("timeout")); } }, ms);
    promise.then(r=>{ if(!done){ done=true; clearTimeout(t); resolve(r);} }).catch(err=>{ if(!done){ done=true; clearTimeout(t); reject(err);} });
  });
}

function validateImageUrl(url, timeout=CONFIG.behavior.validationTimeouts.image){
  return new Promise((resolve)=>{
    if(!url){ resolve(false); return; }
    const img=new Image(); let done=false;
    const t=setTimeout(()=>{ if(!done){ done=true; resolve(false); } }, timeout);
    img.onload=()=>{ if(!done){ done=true; clearTimeout(t); resolve(true);} };
    img.onerror=()=>{ if(!done){ done=true; clearTimeout(t); resolve(false);} };
    img.src=url;
  });
}
function validateVideoUrl(url, timeout=CONFIG.behavior.validationTimeouts.video){
  return new Promise((resolve)=>{
    if(!url){ resolve(false); return; }
    const v=document.createElement('video'); let done=false;
    const t=setTimeout(()=>{ if(!done){ done=true; resolve(false); } }, timeout);
    v.preload='metadata';
    v.onloadedmetadata=()=>{ if(!done){ done=true; clearTimeout(t); resolve(true); } };
    v.onerror=()=>{ if(!done){ done=true; clearTimeout(t); resolve(false); } };
    v.src=url;
  });
}

function extractVimeoId(url=""){
  const patterns=[/vimeo\.com\/(?:video\/)?(\d+)/,/player\.vimeo\.com\/video\/(\d+)/];
  for(const re of patterns){ const m=(url||"").match(re); if(m && m[1]) return m[1]; }
  return null;
}

/* fetch vimeo oembed but with timeout to avoid blocking first paint */
async function fetchVimeoMeta(url){
  if(!url) return null;
  if(vimeoMetaCache.has(url)) return vimeoMetaCache.get(url);
  try{
    const fetchP = fetch('https://vimeo.com/api/oembed.json?width=960&url=' + encodeURIComponent(url), {mode:'cors'});
    const res = await withTimeoutPromise(fetchP, CONFIG.behavior.validationTimeouts.vimeoOembed);
    if(!res.ok) throw new Error('bad oembed');
    const data = await res.json();
    let thumb = data.thumbnail_url || null;
    if(thumb && /_\d+x?\.(jpg|png)$/.test(thumb)){ thumb = thumb.replace(/_\d+x?\.(jpg|png)$/, "_960.jpg"); }
    const width = data.width || 16, height = data.height || 9;
    const ratio = width/height;
    const meta = {thumb,width,height,ratio};
    vimeoMetaCache.set(url, meta);
    return meta;
  }catch(e){
    return null;
  }
}

/* ============================
   Sizing helpers (for lightbox image scaling / iframe containment)
   ============================ */
function sizeHostToAspect(container, host, aspect){
  if(!container || !host || !aspect) return;
  const boxW = container.clientWidth;
  const boxH = container.clientHeight;
  let targetW, targetH;
  if(boxW / boxH > aspect){ targetH = boxH; targetW = Math.min(boxW, Math.round(targetH * aspect)); }
  else { targetW = boxW; targetH = Math.min(boxH, Math.round(targetW / aspect)); }
  host.style.width = targetW + "px";
  host.style.height = targetH + "px";
}
function attachResponsiveSizer(container, host, getAspect){
  if(host._ro){ try{host._ro.disconnect();}catch(e){} }
  if(host._onResize){ window.removeEventListener('resize', host._onResize); }
  const ro = new ResizeObserver(()=>{ const ar = getAspect(); if(ar) sizeHostToAspect(container, host, ar); });
  ro.observe(container);
  const onResize = ()=>{ const ar = getAspect(); if(ar) sizeHostToAspect(container, host, ar); };
  window.addEventListener('resize', onResize);
  host._ro = ro; host._onResize = onResize;
  requestAnimationFrame(()=>{ const ar = getAspect(); if(ar) sizeHostToAspect(container, host, ar); });
}
function containIframeToBox(iframe, ratio){
  const box = iframe.parentElement; if(!box) return;
  const w = box.clientWidth, h = box.clientHeight; if(!w || !h) return;
  const boxRatio = w / h;
  let targetW, targetH;
  if(ratio > boxRatio){ targetW = w; targetH = Math.round(w / ratio); }
  else { targetH = h; targetW = Math.round(h * ratio); }
  iframe.style.width = targetW + "px";
  iframe.style.height = targetH + "px";
  iframe.style.position="absolute"; iframe.style.top="50%"; iframe.style.left="50%"; iframe.style.transform="translate(-50%,-50%)";
}
function coverIframeToBox(iframe, ratio){
  const box = iframe.parentElement; if(!box) return;
  const w = box.clientWidth, h = box.clientHeight;
  if(!w || !h) return;
  const boxRatio = w / h;
  let targetW, targetH;
  if(ratio > boxRatio){ targetH = h; targetW = Math.ceil(h * ratio); }
  else { targetW = w; targetH = Math.ceil(w * ratio); }
  iframe.style.width  = targetW + "px";
  iframe.style.height = targetH + "px";
  iframe.style.position="absolute"; iframe.style.top="50%"; iframe.style.left="50%"; iframe.style.transform="translate(-50%,-50%)";
}

/* ============================
   Cleanup & small helpers
   ============================ */
function destroyVimeoPlayersIn(node){
  const iframes = node.querySelectorAll("iframe[data-vimeo-iframe='1']");
  if(!iframes.length) return;
  iframes.forEach((ifr)=>{
    const pl = vimeoPlayerMap.get(ifr);
    try{ pl?.unload?.(); }catch(e){}
    vimeoPlayerMap.delete(ifr);
    try{ ifr.remove(); }catch(e){}
  });
}
function clearVimeoIdle(scope){
  const ref = (scope==="main") ? mainVimeoRef : lightboxVimeoRef;
  if(!ref) return;
  try{
    if(ref.idleTimer) clearTimeout(ref.idleTimer);
    if(ref.player){ ref.player.pause().catch(()=>{}); }
    if(ref.ro){ try{ref.ro.disconnect();}catch(e){} }
    if(ref.iframe && ref.iframe.parentElement){ ref.iframe.parentElement.removeChild(ref.iframe); }
  }catch(e){}
  if(scope==="main") mainVimeoRef=null; else lightboxVimeoRef=null;
}
function pauseVimeoIn(container){
  const iframe = container.querySelector("iframe[data-vimeo-iframe='1']");
  if(!iframe) return;
  const player = vimeoPlayerMap.get(iframe);
  if(player){ try{ player.pause(); }catch(e){} }
}

/* ============================
   Idle preview logic (local videos)
   includes loop limit handling
   ============================ */
const clearMainIdleAndPreview=()=>{
  if(mainIdleTimer){clearTimeout(mainIdleTimer);mainIdleTimer=null;}
  if(mainVideoEl){
    try{
      if(mainVideoEl._previewLoopActive){
        mainVideoEl._previewLoopActive=false;
        mainVideoEl.removeEventListener("timeupdate",mainVideoEl._previewTimeHandler);
      }
    }catch(e){}
  }
};
const clearLightboxIdleAndPreview=()=>{
  if(lightboxIdleTimer){clearTimeout(lightboxIdleTimer);lightboxIdleTimer=null;}
  if(lightboxVideoEl){
    try{
      if(lightboxVideoEl._previewLoopActive){
        lightboxVideoEl._previewLoopActive=false;
        lightboxVideoEl.removeEventListener("timeupdate",lightboxVideoEl._previewTimeHandler);
      }
    }catch(e){}
  }
};
const attachIdleLogicToVideo=(v,index,scope)=>{
  if(scope==="main"){ clearMainIdleAndPreview(); mainVideoEl=v; } else { clearLightboxIdleAndPreview(); lightboxVideoEl=v; }
  v.controls=false; v.playsInline=true; v.preload="auto";
  v._previewLoopActive=false; v._hasEndedPlaying=false; v._loopCount=0;
  const loopLimit = CONFIG.behavior.loopLimits[scope] ?? 0;

  const onEnded=()=>{ v._hasEndedPlaying=true; if(v._previewLoopActive){ v._previewLoopActive=false; v.removeEventListener("timeupdate",v._previewTimeHandler); } };
  v.addEventListener("ended",onEnded);

  const startPreview=()=>{ try{
    v.muted=true; v.controls=false; v._previewLoopActive=true; v.currentTime=0;
    const proxy = v.parentElement && v.parentElement.querySelector('.poster-proxy');
    let fadedProxy=false;
    v._previewTimeHandler=function(){
      if(!fadedProxy && v.currentTime>0.05){
        fadedProxy=true;
        if(proxy){ gsap.to(proxy,{opacity:0,duration:0.25,onComplete:()=>{ try{proxy.remove();}catch(e){} }}); }
      }
      if(v.currentTime>=PREVIEW_DURATION){
        v._loopCount = (v._loopCount||0) + 1;
        if(loopLimit>0 && v._loopCount >= loopLimit){
          try{
            v._previewLoopActive=false;
            v.removeEventListener("timeupdate",v._previewTimeHandler);
            v.pause(); v.currentTime=0;
            if(proxy) gsap.to(proxy,{opacity:1,duration:0.2});
            return;
          }catch(e){}
        }
        try{ v.currentTime=0; v.play().catch(()=>{});}catch(e){}
      }
    };
    v.addEventListener("timeupdate",v._previewTimeHandler);
    gsap.fromTo(v,{opacity:0},{opacity:1,duration:0.28});
    v.play().catch(()=>{});
  }catch(e){} };

  const startIdleTimer=()=>{ if(scope==="main"){ if(mainIdleTimer) clearTimeout(mainIdleTimer); mainIdleTimer=setTimeout(()=>{ if(!v._hasEndedPlaying) startPreview(); mainIdleTimer=null; },IDLE_TIMEOUT); } else { if(lightboxIdleTimer) clearTimeout(lightboxIdleTimer); lightboxIdleTimer=setTimeout(()=>{ if(!v._hasEndedPlaying) startPreview(); lightboxIdleTimer=null; },IDLE_TIMEOUT); } };

  const poster=v.getAttribute("poster")||"";
  if(!poster){ startPreview(); } else { const img=new Image(); img.onload=()=>{ startIdleTimer(); }; img.onerror=()=>{ startPreview(); }; img.src=poster; }

  v._stopPreviewAndIdle=()=>{ try{ if(v._previewLoopActive){ v._previewLoopActive=false; v.removeEventListener("timeupdate",v._previewTimeHandler); v._previewTimeHandler=null; v.pause(); v.currentTime=0; } }catch(e){} if(scope==="main"){ if(mainIdleTimer){clearTimeout(mainIdleTimer); mainIdleTimer=null;} } else { if(lightboxIdleTimer){clearTimeout(lightboxIdleTimer); lightboxIdleTimer=null;} } };
};

/* ============================
   Vimeo idle preview (main & lightbox) with loop limit
   - sets placeholder initially and only replaces with iframe when preview plays
   ============================ */
async function attachIdleLogicToVimeo(host, previewEl, scope){
  clearVimeoIdle(scope);
  host._idleEnabled = true;

  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
  const meta = await fetchVimeoMeta(vimeoUrl) || {ratio:16/9};
  const ratio = meta.ratio || 16/9;

  const posterImg = host.querySelector('img');
  const waitPoster = new Promise((resolve)=> {
    const src = posterImg && posterImg.getAttribute('src');
    if(!src){ resolve(); return; }
    const img = new Image(); let done=false;
    const t=setTimeout(()=>{ if(!done){done=true; resolve();} }, 600);
    img.onload=()=>{ if(!done){done=true; clearTimeout(t); resolve();} };
    img.onerror=()=>{ if(!done){done=true; clearTimeout(t); resolve();} };
    img.src=src;
  });
  await waitPoster;
  if(!document.body.contains(host) || !host._idleEnabled) return;

  const ref = { idleTimer:null, player:null, iframe:null, ro:null, loopCount:0 };
  if(scope==="main") mainVimeoRef=ref; else lightboxVimeoRef=ref;
  const loopLimit = CONFIG.behavior.loopLimits[scope] ?? 0;

  ref.idleTimer = setTimeout(async ()=>{
    if(!document.body.contains(host) || !host._idleEnabled) return;
    const id = extractVimeoId(vimeoUrl);
    if(!id) return;
    const iframe = document.createElement('iframe');
    iframe.setAttribute('allow','autoplay; fullscreen; picture-in-picture');
    iframe.setAttribute('data-vimeo-iframe','1');
    iframe.style.opacity='0';
    iframe.style.border='0';
    iframe.style.borderRadius='var(--border-radius)';
    const params = new URLSearchParams({autoplay:1, muted:1, controls:0, title:0, byline:0, portrait:0, playsinline:1, dnt:1});
    iframe.src = `https://player.vimeo.com/video/${id}?${params.toString()}`;

    if(!document.body.contains(host) || !host._idleEnabled) return;
    host.appendChild(iframe);

    const player = new Vimeo.Player(iframe);
    ref.player = player; ref.iframe = iframe;

    const fit = ()=>containIframeToBox(iframe, ratio);
    const ro = new ResizeObserver(fit);
    ro.observe(host);
    ref.ro = ro; setTimeout(fit,0);

    let shown=false;
    player.on('timeupdate', (data)=>{
      if(!host._idleEnabled){ try{player.pause();}catch(e){} return; }
      if(!shown && data && typeof data.seconds==='number'){
        shown=true; gsap.to(iframe,{opacity:1,duration:0.25});
      }
      if(data && data.seconds>=PREVIEW_DURATION){
        ref.loopCount = (ref.loopCount||0) + 1;
        if(loopLimit>0 && ref.loopCount >= loopLimit){
          try{
            host._idleEnabled=false;
            player.pause().catch(()=>{});
            if(iframe.parentElement) iframe.parentElement.removeChild(iframe);
            if(ref.ro){ try{ref.ro.disconnect();}catch(e){} }
            if(posterImg){ gsap.to(posterImg,{opacity:1,duration:0.2}); }
            return;
          }catch(e){}
        }
        player.setCurrentTime(0).catch(()=>{});
      }
    });

    try{ await player.setMuted(true); }catch(e){}
    try{ await player.play().catch(()=>{});}catch(e){}
    host._stopVimeoPreviewAndIdle = ()=>{
      host._idleEnabled = false;
      try{
        if(ref.idleTimer){ clearTimeout(ref.idleTimer); ref.idleTimer=null; }
        if(ref.player){ ref.player.pause().catch(()=>{}); }
        if(ref.ro){ try{ref.ro.disconnect();}catch(e){} }
        if(iframe && iframe.parentElement){ iframe.parentElement.removeChild(iframe); }
      }catch(e){}
      if(scope==="main") mainVimeoRef=null; else lightboxVimeoRef=null;
    };
  }, IDLE_TIMEOUT);
}

/* ============================
   Play overlay helpers
   ============================ */
function buildPlayOverlay(onClick){
  const overlay=document.createElement("div");
  overlay.className="play-btn";
  overlay.innerHTML='<span class="circle"><i class="fa-solid fa-play"></i></span>';
  overlay.style.transform='translate(-50%,-50%) scale(.6)';
  overlay.style.opacity='0';
  overlay.addEventListener("click",(e)=>{ e.stopPropagation(); onClick(overlay); });
  return overlay;
}
function animateOverlayIn(overlay){
  if(!overlay) return;
  overlay.style.transform="translate(-50%,-50%) scale(.6)";
  overlay.style.opacity="0";
  gsap.fromTo(overlay,{scale:0.6,opacity:0},{scale:1.05,opacity:1,duration:0.18,ease:"back.out(3)",onComplete:()=>gsap.to(overlay,{scale:1,duration:0.06,ease:"power1.out"})});
}
function animateOverlayOutThen(overlayEl, cb){
  if(!overlayEl){ try{ cb(); }catch(e){} return; }
  gsap.to(overlayEl,{scale:1.6,opacity:0,duration:.35,ease:"power2.out",onStart:()=>{overlayEl.style.pointerEvents="none";},onComplete:()=>{ try{overlayEl.remove();}catch(e){} try{cb();}catch(e){} }});
}

/* ============================
   Local video play flow (unchanged)
   ============================ */
function playVideoOverlay(videoEl,overlayEl){
  if(!videoEl) return;
  try{
    if(typeof videoEl._stopPreviewAndIdle==="function") try{ videoEl._stopPreviewAndIdle(); }catch(err){}
    if(videoEl._previewLoopActive){
      try{ videoEl._previewLoopActive=false; videoEl.removeEventListener("timeupdate",videoEl._previewTimeHandler); videoEl._previewTimeHandler=null; }catch(e){}
    }
    try{ videoEl.currentTime=0; }catch(e){}
    gsap.to(overlayEl,{scale:1.6,opacity:0,duration:.35,ease:"power2.out",
      onStart:()=>{overlayEl.style.pointerEvents="none";},
      onComplete:()=>{ 
        try{overlayEl.remove();}catch(e){} 
        const proxy = videoEl.parentElement && videoEl.parentElement.querySelector('.poster-proxy');
        if(proxy){ try{ proxy.remove(); }catch(e){} }
        videoEl.controls=true; videoEl.muted=false; 
        try{ videoEl.play().catch(()=>{});}catch(e){} 
      }
    });
  }catch(e){}
}

/* ============================
   Host-level play var helper
   ============================ */
function applyHostPlayVars(host, scope){
  const s = CONFIG.styles.playButton;
  if(scope==="lightbox"){
    host.style.setProperty('--play-btn-size-d', s.lightbox.btnDesktop + 'px');
    host.style.setProperty('--play-btn-size-m', s.lightbox.btnMobile + 'px');
    host.style.setProperty('--play-circle-size-d', s.lightbox.circleDesktop + 'px');
    host.style.setProperty('--play-circle-size-m', s.lightbox.circleMobile + 'px');
    host.style.setProperty('--play-icon-size', s.lightbox.iconSize);
  } else {
    host.style.setProperty('--play-btn-size-d', s.main.btnDesktop + 'px');
    host.style.setProperty('--play-btn-size-m', s.main.btnMobile + 'px');
    host.style.setProperty('--play-circle-size-d', s.main.circleDesktop + 'px');
    host.style.setProperty('--play-circle-size-m', s.main.circleMobile + 'px');
    host.style.setProperty('--play-icon-size', s.main.iconSize);
  }
}

/* ============================
   Create hosts (local video, vimeo) & mini players
   ============================ */
function createLocalVideoHost(srcNodeOrUrl, scope, posterFallback, animateOverlay=true, alt=""){
  const host=document.createElement("div");
  host.className="video-host media-host";
  host.style.background="transparent";
  applyHostPlayVars(host, scope);

  const v=document.createElement("video");
  v.controls=false; v.preload="auto"; v.setAttribute("aria-label", alt||"Video");
  v.poster=(isVideo(srcNodeOrUrl)? (srcNodeOrUrl.getAttribute("poster")||posterFallback||"") : (posterFallback||""));
  const s=document.createElement("source");
  s.src=isVideo(srcNodeOrUrl) ? (srcNodeOrUrl.getAttribute("src")||srcNodeOrUrl.src) : srcNodeOrUrl;
  v.appendChild(s);
  v.style.width="100%"; v.style.height="100%";
  v.style.objectFit="contain"; v.style.background="transparent"; v.style.borderRadius="var(--border-radius)";
  host.appendChild(v);

  if(scope==="lightbox"){
    const proxy=document.createElement('img');
    proxy.className='poster-proxy'; proxy.alt=alt||'Video poster';
    proxy.src=v.poster||VIMEO_PLACEHOLDER;
    Object.assign(proxy.style,{position:'absolute',inset:0,width:'100%',height:'100%',objectFit:'cover',objectPosition:'center',borderRadius:'var(--border-radius)'});
    host.appendChild(proxy);
    let aspect=null;
    v.addEventListener("loadedmetadata",()=>{ aspect = (v.videoWidth && v.videoHeight) ? (v.videoWidth / v.videoHeight) : (16/9); attachResponsiveSizer(imgBox, host, ()=>aspect||16/9); });
    attachResponsiveSizer(imgBox, host, ()=>aspect||16/9);
  }

  const overlay = buildPlayOverlay(()=>playVideoOverlay(v,overlay));
  host.appendChild(overlay);
  try{v.load();}catch(e){}
  attachIdleLogicToVideo(v,currentIndex,scope);
  if(animateOverlay) animateOverlayIn(overlay);
  return host;
}

function createVimeoHost(previewEl, scope, animateOverlay=true, alt=""){
  clearVimeoIdle(scope);
  const host=document.createElement("div");
  host.className="video-host vimeo-host media-host";
  host.style.background="transparent";
  applyHostPlayVars(host, scope);

  // show placeholder until we resolve poster
  const posterImg=document.createElement("img");
  posterImg.alt=alt||"Vimeo preview";
  posterImg.src = VIMEO_PLACEHOLDER;
  posterImg.style.width="100%"; posterImg.style.height="100%";
  posterImg.style.borderRadius='var(--border-radius)';
  posterImg.style.objectPosition='center';
  posterImg.style.objectFit = (scope==="lightbox") ? 'cover' : 'contain';
  host.appendChild(posterImg);

  (async ()=>{
    const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
    let poster = previewEl.dataset.mainPoster || vimeoPosterCache.get(vimeoUrl);
    if(!poster){
      poster = await resolveVimeoPosterForMain(previewEl);
      if(poster){ await validateImageUrl(poster, 3000); vimeoPosterCache.set(vimeoUrl, poster); previewEl.dataset.mainPoster = poster; }
    }
    if(poster){ posterImg.src = poster; }

    if(scope==="lightbox"){
      const meta = await fetchVimeoMeta(vimeoUrl);
      const ratio = meta && meta.ratio ? meta.ratio : (16/9);
      attachResponsiveSizer(imgBox, host, ()=>ratio);
    }

    attachIdleLogicToVimeo(host, previewEl, scope);
  })();

  const overlay = buildPlayOverlay((overlayEl)=>{
    host._idleEnabled = false;
    if(typeof host._stopVimeoPreviewAndIdle==="function") try{ host._stopVimeoPreviewAndIdle(); }catch(e){}
    animateOverlayOutThen(overlayEl, async ()=>{
      const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
      const id = extractVimeoId(vimeoUrl);
      if(!id) return;
      const iframe=document.createElement("iframe");
      iframe.setAttribute("allow","autoplay; fullscreen; picture-in-picture");
      iframe.setAttribute("data-vimeo-iframe","1");
      iframe.style.width="100%"; iframe.style.height="100%"; iframe.style.border="0";
      const params = new URLSearchParams({autoplay:1, muted:0, title:0, byline:0, portrait:0, playsinline:1});
      host.innerHTML=""; host.appendChild(iframe);
      iframe.src = `https://player.vimeo.com/video/${id}?${params.toString()}`;
      try{
        const player = new Vimeo.Player(iframe);
        vimeoPlayerMap.set(iframe, player);
        await player.play().catch(()=>{});
      }catch(e){}
    });
  });
  host.appendChild(overlay);
  if(animateOverlay) animateOverlayIn(overlay);
  return host;
}

/* Mini strip players for vimeo previews
   - but we first show a poster image immediately, so there's never a blank preview tile
*/
async function buildVimeoMini(previewEl, alt=""){
  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
  const id = extractVimeoId(vimeoUrl);
  if(!id) return;

  previewEl.innerHTML = "";
  const mini = document.createElement('div'); mini.className = 'vimeo-mini';
  previewEl.appendChild(mini);

  const posterImg = document.createElement('img');
  posterImg.className = 'vimeo-mini-poster'; posterImg.alt = alt || 'Vimeo';
  posterImg.src = VIMEO_PLACEHOLDER; mini.appendChild(posterImg);

  // overlay visible immediately
  const overlay = document.createElement("span");
  overlay.className = "play-overlay";
  overlay.innerHTML = '<span class="circle"><i class="fa-solid fa-play"></i></span>';
  previewEl.appendChild(overlay);

  const meta = await fetchVimeoMeta(vimeoUrl);
  const ratio = meta && meta.ratio ? meta.ratio : (16/9);
  const thumb = meta && meta.thumb;
  if(thumb && await validateImageUrl(thumb, CONFIG.behavior.validationTimeouts.thumb)){ posterImg.src = thumb; }

  // create iframe that will autoplay muted; poster remains visible until small loop starts
  const params = new URLSearchParams({autoplay:1, muted:1, controls:0, loop:0, title:0, byline:0, portrait:0, dnt:1, playsinline:1});
  const iframe = document.createElement('iframe');
  iframe.src = `https://player.vimeo.com/video/${id}?${params.toString()}`;
  iframe.setAttribute('allow','autoplay; fullscreen; picture-in-picture');
  iframe.setAttribute('tabindex','-1');
  mini.appendChild(iframe);

  const player = new Vimeo.Player(iframe);
  const loopLimit = CONFIG.behavior.loopLimits.preview ?? 0;
  const state = { loopCount: 0, posterHidden: false };
  const keepPlaying = ()=>{
    player.getPaused().then(p=>{ if(p) player.play().catch(()=>{}); }).catch(()=>{});
  };

  try{
    await player.ready();
    await player.setMuted(true);
    await player.setLoop(false);
    await player.setVolume(0);
    try{ await player.setQuality(CONFIG.behavior.vimeoMiniQuality); }catch(e){}
    await player.play().catch(()=>{});
  }catch(e){}

  player.on('timeupdate',(data)=>{
    if(data){
      if(!state.posterHidden && typeof data.seconds === 'number'){
        state.posterHidden = true;
        posterImg.style.opacity = '0';
      }
      if(data.seconds >= PREVIEW_DURATION){
        state.loopCount++;
        if(loopLimit>0 && state.loopCount >= loopLimit){
          try{ player.pause().catch(()=>{}); posterImg.style.opacity='1'; if(iframe.parentElement) iframe.parentElement.removeChild(iframe); return; }catch(e){}
        }
        player.setCurrentTime(0).catch(()=>{});
      }
    }
  });
  player.on('pause', keepPlaying);
  player.on('ended', ()=>{ player.setCurrentTime(0).then(()=>player.play().catch(()=>{})).catch(()=>{}); });

  const fit = ()=>coverIframeToBox(iframe, ratio);
  const ro = new ResizeObserver(fit);
  ro.observe(mini); setTimeout(fit,0);

  vimeoMiniMap.set(previewEl, {player, iframe, container: mini, posterEl: posterImg, ratio, ro, keepPlaying, state});
}

/* Start vimeo minis and local loops immediately for first-time visitors */
async function initVimeoStripMiniPlayers(){ const vims = previews.filter(p=>getPreviewType(p)==="vimeo"); for(const p of vims){ await buildVimeoMini(p, p.dataset.alt || "Vimeo"); } }
function initLocalStripLoops(){ previews.forEach((p)=>{ if(getPreviewType(p)!=="video") return; const pv=p.querySelector("video"); if(!pv) return; pv.muted=true;pv.playsInline=true;pv.loop=false;pv.preload="auto"; pv._loopCount=0; const loopLimit = CONFIG.behavior.loopLimits.preview ?? 0; const kick=()=>{try{pv.currentTime=0;pv.play().catch(()=>{});}catch(e){}}; pv.addEventListener("loadeddata",kick,{once:true}); try{pv.load();kick();}catch(e){} pv.addEventListener("timeupdate",()=>{ if(pv.currentTime>=PREVIEW_DURATION){ pv._loopCount=(pv._loopCount||0)+1; if(loopLimit>0 && pv._loopCount>=loopLimit){ try{pv.pause();pv.currentTime=0; const poster = pv.getAttribute('poster'); if(poster){ let proxy = p.querySelector('.poster-proxy'); if(!proxy && poster){ proxy=document.createElement('img'); proxy.className='poster-proxy'; proxy.src=poster; Object.assign(proxy.style,{position:'absolute',inset:0,width:'100%',height:'100%',objectFit:'cover',borderRadius:'inherit'}); p.appendChild(proxy);} if(proxy) gsap.to(proxy,{opacity:1,duration:0.2}); } return; }catch(e){} } try{pv.currentTime=0;pv.play().catch(()=>{});}catch(e){} } }); }); }

/* Kick previews on first pointerdown is still kept as fallback for some autoplay-blocking situations */
window.addEventListener("pointerdown",()=>{
  previews.forEach(p=>{
    const v=p.querySelector("video"); try{ if(v&&v.paused) v.play().catch(()=>{});}catch(e){}
    if(getPreviewType(p)==="vimeo"){ const mini = vimeoMiniMap.get(p); if(mini && mini.player){ mini.player.play().catch(()=>{}); } }
  });
},{once:true});

/* ============================
   Transition & cloning helpers
   ============================ */
const scrollPreviewIntoView=(idx,dur=0.5)=>{ const el=previews[idx]; const target=el.offsetLeft-(previewContainer.clientWidth/2 - el.clientWidth/2); gsap.to(previewContainer,{scrollLeft:target,duration:dur,ease:"power2.inOut"}); };
const cloneForAnim=(node)=>{ const m=node.cloneNode(true); m.style.position="absolute";m.style.top=0;m.style.left=0;m.style.width="100%";m.style.height="100%"; m.style.objectFit="cover"; m.style.borderRadius="var(--border-radius)"; if(isVideo(m)){m.muted=true;m.playsInline=true;m.controls=false;try{m.pause();m.currentTime=0}catch(e){}} return m; };
function visualCloneFor(previewEl){
  const t = getPreviewType(previewEl);
  if(t==="vimeo"){
    const img = document.createElement("img");
    const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
    const resolved = previewEl.dataset.mainPoster || vimeoPosterCache.get(vimeoUrl) || VIMEO_PLACEHOLDER;
    img.src = resolved; img.alt = previewEl.dataset.alt || "Vimeo poster";
    img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; img.style.borderRadius="var(--border-radius)";
    return cloneForAnim(img);
  }
  const node = mediaOf(previewEl);
  if(!node){
    const ph = document.createElement("img"); ph.src = VIMEO_PLACEHOLDER; return cloneForAnim(ph);
  }
  return cloneForAnim(node);
}

/* ============================
   Main & Lightbox controls
   ============================ */
function buildPlayOverlayForHost(host, onPlay){ const overlay=buildPlayOverlay(onPlay); host.appendChild(overlay); animateOverlayIn(overlay); }

const handleMainClick=(e)=>{
  const previewEl = previews[currentIndex];
  if(!previewEl) return;
  const type = getPreviewType(previewEl);
  if(type==="video"){
    const host=mainImageBox.querySelector(".video-host");
    if(!host) return;
    const videoEl=host.querySelector("video");
    const clickedPlayBtn=e.target.closest(".play-btn");
    if(clickedPlayBtn && videoEl){
      e.stopPropagation();
      if(typeof videoEl._stopPreviewAndIdle==="function")try{videoEl._stopPreviewAndIdle();}catch(err){}
      playVideoOverlay(videoEl,clickedPlayBtn);
    }
    return;
  } else if(type==="vimeo"){
    const clickedPlayBtn=e.target.closest(".play-btn");
    if(clickedPlayBtn){ clickedPlayBtn.click(); return; }
    return;
  } else {
    openLightbox(currentIndex);
  }
};

const handleGalleryClick=(e)=>{
  if(!galleryViewer.classList.contains("active")) return;
  if(e.target.closest('.arrows') || e.target.closest('.prev') || e.target.closest('.next') || e.target.closest('.close')) return;
  const media = imgBox.querySelector('img,video,iframe');
  if(media){ if(media.contains(e.target) || e.target === media) return; const mediaHost = imgBox.querySelector('.media-host'); if(mediaHost && mediaHost.contains(e.target)) return; }
  closeLightbox();
};

mainImageBox.addEventListener("click",handleMainClick);
galleryViewer.addEventListener("click",handleGalleryClick);

/* Open/close lightbox */
function openLightbox(index){
  gsap.to(galleryViewer,{opacity:1,duration:0.3,onStart:()=>{
    galleryViewer.classList.add("active");
    document.body.classList.add("no-scroll");
    currentIndex=index; startIndex=index; updateSlide(true);
  }});
}
function cleanupLightboxHost(){ const old = imgBox.firstElementChild; if(!old) return; if(old._ro){ try{old._ro.disconnect();}catch(e){} } if(old._onResize){ window.removeEventListener('resize', old._onResize); } }
function closeLightbox(){
  const lbVideo=imgBox.querySelector('video');
  if(lbVideo){
    try{ lbVideo.pause(); lbVideo.currentTime=0; lbVideo.controls=false; if(lbVideo._previewLoopActive){ lbVideo._previewLoopActive=false; lbVideo.removeEventListener("timeupdate",lbVideo._previewTimeHandler); } }catch(e){}
  }
  clearLightboxIdleAndPreview();
  clearVimeoIdle("lightbox");
  pauseVimeoIn(imgBox);
  destroyVimeoPlayersIn(imgBox);

  gsap.to(galleryViewer,{opacity:0,duration:0.3,onComplete:()=>{
    galleryViewer.classList.remove("active");
    document.body.classList.remove("no-scroll");
    if(currentIndex!==startIndex){
      const direction=currentIndex>startIndex?1:-1;
      const steps=Math.abs(currentIndex-startIndex);
      const fromMedia=visualCloneFor(previews[startIndex]);
      const toMedia=visualCloneFor(previews[currentIndex]);
      const wrapper=mainImageBox;
      wrapper.style.position="relative"; wrapper.innerHTML="";
      wrapper.appendChild(fromMedia); wrapper.appendChild(toMedia);
      gsap.set(toMedia,{x:direction>0?"100%":"-100%"});
      const targetPreview=previews[currentIndex];
      const targetScroll=targetPreview.offsetLeft-(previewContainer.clientWidth/2-targetPreview.clientWidth/2);
      const tl=gsap.timeline({onComplete:()=>{ wrapper.innerHTML=""; setMainMedia(currentIndex); previews.forEach(p=>p.classList.remove("active")); previews[currentIndex].classList.add("active"); }});
      tl.addLabel("start").to(fromMedia,{x:direction>0?"-100%":"100%",duration:0.5,ease:"power2.inOut"},"start").to(toMedia,{x:"0%",duration:0.5,ease:"power2.inOut"},"start").to(previewContainer,{scrollLeft:targetScroll,duration:0.5,ease:"power2.inOut"},"start").to({}, {duration:0.5,onUpdate:()=>{const progress=tl.progress();const stepIndex=Math.round(startIndex + progress*steps*direction); if(previews[stepIndex]){previews.forEach(p=>p.classList.remove("active"));previews[stepIndex].classList.add("active");}}},"start");
    }
    cleanupLightboxHost();
  }});
}

/* Update slide (lightbox) — images auto-scale to intrinsic aspect ratio now */
function updateSlide(animateIn=false){
  cleanupLightboxHost();
  destroyVimeoPlayersIn(imgBox);
  imgBox.innerHTML="";
  const previewEl = previews[currentIndex];
  if(!previewEl) return;
  const type = getPreviewType(previewEl);
  let hostOrNode;

  if(type==="video"){
    const node = mediaOf(previewEl);
    hostOrNode = createLocalVideoHost(node,"lightbox",node?.getAttribute("poster")||"",false, previewEl.dataset.alt||"Video");
  } else if(type==="vimeo"){
    hostOrNode = createVimeoHost(previewEl,"lightbox",false, previewEl.dataset.alt||"Vimeo video");
  } else {
    // Image: create a host that is sized to the image intrinsic ratio
    const original = mediaOf(previewEl);
    const host = document.createElement('div'); host.className='media-host img-host'; host.style.background='transparent'; host.style.display='flex'; host.style.alignItems='center'; host.style.justifyContent='center'; host.style.borderRadius='var(--border-radius)';
    const img = document.createElement('img'); img.alt = previewEl.dataset.alt || 'Image';
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='contain'; img.style.borderRadius='var(--border-radius)';
    if(original && original.tagName && original.tagName.toLowerCase()==='img') img.src = original.src;
    else img.src = (original && original.getAttribute && (original.getAttribute('src') || original.src)) || '';
    host.appendChild(img);
    imgBox.appendChild(host);
    hostOrNode = host;
    const applyAspect = ()=>{
      const w = img.naturalWidth, h = img.naturalHeight;
      const ratio = (w && h) ? (w/h) : (16/9);
      attachResponsiveSizer(imgBox, host, ()=>ratio);
    };
    if(img.complete && img.naturalWidth) applyAspect(); else img.addEventListener('load', applyAspect, {once:true});
  }

  if(!hostOrNode.parentElement) imgBox.appendChild(hostOrNode);
  if(animateIn){ const overlay=imgBox.querySelector('.play-btn'); if(overlay) animateOverlayIn(overlay); }
  return hostOrNode;
}
function nextSlide(){ if(isAnimating) return; currentIndex=(currentIndex+1)%previews.length; slideAnimation(true); }
function prevSlide(){ if(isAnimating) return; currentIndex=(currentIndex-1+previews.length)%previews.length; slideAnimation(false); }
function slideAnimation(isNext){
  isAnimating=true; clearLightboxIdleAndPreview(); clearVimeoIdle("lightbox"); pauseVimeoIn(imgBox); destroyVimeoPlayersIn(imgBox);
  const media=updateSlide(); gsap.fromTo(media,{opacity:0,x:isNext?"100%":"-100%"},{opacity:1,x:"0%",duration:0.5,ease:"power2.out",onComplete:()=>{ isAnimating=false; const overlay=imgBox.querySelector('.play-btn'); if(overlay) animateOverlayIn(overlay); }});
}

/* ============================
   Keyboard & touch
   ============================ */
document.addEventListener("keydown",(e)=>{
  const active=document.activeElement; if(active && (active.tagName==="INPUT"||active.tagName==="TEXTAREA"||active.isContentEditable)) return;
  if(e.key==="Escape"){ if(galleryViewer.classList.contains("active")) closeLightbox(); return; }
  if(e.code==="Space"){ e.preventDefault();
    if(galleryViewer.classList.contains("active")){
      const overlay=imgBox.querySelector('.play-btn');
      const v=imgBox.querySelector('video');
      const vf=imgBox.querySelector("iframe[data-vimeo-iframe='1']");
      if(overlay && (v || getPreviewType(previews[currentIndex])==="vimeo")){ overlay.click(); }
      else if(v){ if(v.paused) v.play().catch(()=>{}); else v.pause(); }
      else if(vf){ const player = vimeoPlayerMap.get(vf); if(player){ player.getPaused().then(paused=> paused ? player.play() : player.pause()).catch(()=>{}); } }
    } else {
      const overlay=mainImageBox.querySelector('.play-btn');
      const v=mainImageBox.querySelector('video');
      const vf=mainImageBox.querySelector("iframe[data-vimeo-iframe='1']");
      const isVimeo = (getPreviewType(previews[currentIndex])==="vimeo");
      if(overlay && (v || isVimeo)){ overlay.click(); }
      else if(v){ if(v.paused) v.play().catch(()=>{}); else v.pause(); }
      else if(vf){ const player = vimeoPlayerMap.get(vf); if(player){ player.getPaused().then(paused=> paused ? player.play() : player.pause()).catch(()=>{}); } }
    }
    return;
  }
  if(e.key==="ArrowRight"){ if(galleryViewer.classList.contains("active")) nextSlide(); return; }
  if(e.key==="ArrowLeft"){ if(galleryViewer.classList.contains("active")) prevSlide(); return; }
});
let touchStartX=0; galleryViewer.addEventListener("touchstart",(e)=>{ touchStartX=e.changedTouches[0].screenX; }); galleryViewer.addEventListener("touchend",(e)=>{ const diff=e.changedTouches[0].screenX - touchStartX; if(Math.abs(diff)>50){ if(diff>0) prevSlide(); else nextSlide(); } });

/* ============================
   Preview creation helpers (vimeo preview tile now shows poster immediately)
   ============================ */
function createPreviewShell(){ const p = document.createElement('div'); p.className = 'preview skeleton'; return p; }

function createPreviewFromItem(item){
  const p = document.createElement('div'); p.className = 'preview';
  p.dataset.type = item.type; p.dataset.alt = item.alt || '';
  if(item.type === 'image'){
    const img = document.createElement('img'); img.src = (item.thumbValid ? item.thumb : item.src); img.alt = item.alt || 'Image'; p.appendChild(img);
  } else if(item.type === 'video'){
    const vid = document.createElement('video'); vid.src = item.src; if(item.posterValid && item.poster) vid.setAttribute('poster', item.poster);
    vid.muted = true; vid.playsInline = true; vid.preload = 'auto'; vid.setAttribute('aria-label', item.alt || 'Video'); p.appendChild(vid);
    const overlay = document.createElement('span'); overlay.className = 'play-overlay'; overlay.innerHTML = '<span class="circle"><i class="fa-solid fa-play"></i></span>'; p.appendChild(overlay);
  } else if(item.type === 'vimeo'){
    // show an immediate poster image (local poster if valid, else placeholder) and play overlay.
    p.dataset.src = item.src;
    if(item.poster){ p.dataset.poster = item.poster; }
    const img = document.createElement('img');
    if(item.posterValid && item.poster) img.src = item.poster; else {
      // if we already have cached vimeo thumbnail, use it; else placeholder until metadata resolves
      const meta = vimeoMetaCache.get(item.src);
      if(meta && meta.thumb) img.src = meta.thumb;
      else img.src = VIMEO_PLACEHOLDER;
    }
    img.alt = item.alt || 'Vimeo thumbnail';
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.borderRadius='inherit';
    p.appendChild(img);
    const overlay = document.createElement('span'); overlay.className='play-overlay'; overlay.innerHTML = '<span class="circle"><i class="fa-solid fa-play"></i></span>'; p.appendChild(overlay);
  }
  return p;
}

/* ============================
   Visual transitions when clicking previews (keeps prior behaviour)
   ============================ */
function wirePreviewClicks(){
  previews.forEach((preview,index)=>{
    preview.addEventListener("click",()=>{
      if(index===currentIndex){ scrollPreviewIntoView(index,0.35); return; }
      const direction=index>currentIndex?1:-1;
      destroyVimeoPlayersIn(mainImageBox); clearVimeoIdle("main");
      const live = mainImageBox.firstElementChild;
      const wrapper=document.createElement('div');
      Object.assign(wrapper.style,{position:'relative', width:'100%', height:'100%', borderRadius:'var(--border-radius)', overflow:'hidden', pointerEvents:'none'});
      if(live){
        mainImageBox.appendChild(wrapper);
        live.style.position="absolute"; live.style.top='0'; live.style.left='0'; live.style.width='100%'; live.style.height='100%';
        wrapper.appendChild(live);
      }else mainImageBox.appendChild(wrapper);
      const toMedia=visualCloneFor(preview);
      wrapper.appendChild(toMedia);
      gsap.set(toMedia,{x:direction>0?"100%":"-100%"});
      const steps=Math.abs(index-currentIndex);
      const tl=gsap.timeline({onComplete:()=>{ mainImageBox.innerHTML=""; setMainMedia(index); previews.forEach(p=>p.classList.remove("active")); preview.classList.add("active"); currentIndex=index; }});
      tl.addLabel("start");
      if(live) tl.to(live,{x:direction>0?"-100%":"100%",duration:0.5,ease:"power2.inOut"},"start");
      tl.to(toMedia,{x:"0%",duration:0.5,ease:"power2.inOut"},"start").to(previewContainer,{scrollLeft:preview.offsetLeft-(previewContainer.clientWidth/2-preview.clientWidth/2),duration:0.5,ease:"power2.inOut"},"start").to({}, {duration:0.3,onUpdate:function(){const progress=this.progress();const stepIndex=Math.round(currentIndex + progress*steps*direction); if(previews[stepIndex]){previews.forEach(p=>p.classList.remove("active"));previews[stepIndex].classList.add("active");}}},"start");
    });
  });
}

/* ============================
   Resolve & validate vimeo poster (prefer local poster)
   - this function is used at boot for first-time visitors to avoid flashes
   ============================ */
async function resolveVimeoPosterForMain(previewEl){
  const localPoster = previewEl.dataset.poster || previewEl.getAttribute && previewEl.getAttribute('data-poster') || "";
  if(localPoster){
    const valid = await validateImageUrl(localPoster, CONFIG.behavior.validationTimeouts.poster);
    if(valid) return localPoster;
  }
  const vimeoUrl = previewEl.dataset.src || previewEl.dataset.vimeo || "";
  const meta = await fetchVimeoMeta(vimeoUrl);
  const thumb = meta && meta.thumb;
  if(thumb && await validateImageUrl(thumb, 3500)) return thumb;
  return VIMEO_PLACEHOLDER;
}

/* Background retry for vimeo meta */
async function attemptVimeoMetaRecovery(previewEl, attemptsLeft=CONFIG.behavior.vimeoMetaRetryAttempts){
  if(!previewEl || !previewEl.dataset.src) return;
  const url = previewEl.dataset.src;
  const meta = await fetchVimeoMeta(url);
  if(meta){
    vimeoMetaCache.set(url,meta);
    if(meta.thumb){ vimeoPosterCache.set(url, meta.thumb); previewEl.dataset._metaResolved="1"; previewEl.dataset._ratio = meta.ratio; }
    const mini = previewEl.querySelector('.vimeo-mini');
    if(mini){
      const posterImg = mini.querySelector('img.vimeo-mini-poster');
      if(posterImg && meta.thumb){ posterImg.src = meta.thumb; }
      const iframe = mini.querySelector('iframe');
      if(iframe){ const fit = ()=>coverIframeToBox(iframe, meta.ratio); const ro=new ResizeObserver(fit); ro.observe(mini); setTimeout(fit,0); }
    }
    if(previewEl === previews[currentIndex]) {
      const mainHost = mainImageBox.querySelector('.video-host.vimeo-host');
      if(mainHost){
        const img = mainHost.querySelector('img');
        if(img && meta.thumb) img.src = meta.thumb;
      }
    }
  } else {
    if(attemptsLeft>0) setTimeout(()=>attemptVimeoMetaRecovery(previewEl, attemptsLeft-1), CONFIG.behavior.vimeoMetaRetryDelay);
  }
}

/* ============================
   Set main media (uses resolved posters to avoid flashes)
   ============================ */
function setMainMedia(index){
  const previewEl = previews[index];
  if(!previewEl) return;
  const type = getPreviewType(previewEl);
  const srcNode=mediaOf(previewEl);

  destroyVimeoPlayersIn(mainImageBox);
  clearVimeoIdle("main");

  mainImageBox.innerHTML="";
  if(type==="video" && srcNode){
    mainImageBox.style.background="black";
    const alt = previewEl.dataset.alt || "Video";
    mainImageBox.appendChild(createLocalVideoHost(srcNode,"main",srcNode?.getAttribute("poster")||"",true,alt));
    clearVimeoIdle("main");
  } else if(type==="vimeo"){
    mainImageBox.style.background="black";
    const alt = previewEl.dataset.alt || "Vimeo video";
    // ensure previewEl.dataset.mainPoster exists to avoid flash - createVimeoHost will update host poster async
    const host = createVimeoHost(previewEl,"main",true,alt);
    mainImageBox.appendChild(host);
    clearMainIdleAndPreview();
  } else {
    mainImageBox.style.background="#ddd";
    const img=srcNode ? srcNode.cloneNode(true) : document.createElement("img");
    img.alt = previewEl.dataset.alt || "Image";
    if(!srcNode){ img.src = VIMEO_PLACEHOLDER; }
    img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; img.style.borderRadius="var(--border-radius)";
    mainImageBox.appendChild(img);
    clearMainIdleAndPreview(); clearVimeoIdle("main");
  }
}

/* ============================
   Validation of each entry in GALLERY_DATA
   - vimeo items accepted if ID exists; meta fetch is attempted but not required
   ============================ */
async function validateItem(item){
  const t = (item.type||'image').toLowerCase();
  if(t==='image'){
    const ok = await validateImageUrl(item.src, CONFIG.behavior.validationTimeouts.image);
    if(!ok) return null;
    const thumbValid = item.thumb ? await validateImageUrl(item.thumb, CONFIG.behavior.validationTimeouts.thumb) : false;
    return {...item, type:'image', thumbValid};
  }
  if(t==='video'){
    const ok = await validateVideoUrl(item.src, CONFIG.behavior.validationTimeouts.video);
    if(!ok) return null;
    const posterValid = item.poster ? await validateImageUrl(item.poster, CONFIG.behavior.validationTimeouts.poster) : false;
    return {...item, type:'video', posterValid, thumbValid:false};
  }
  if(t==='vimeo'){
    const id = extractVimeoId(item.src||'');
    if(!id) return null;
    const meta = await fetchVimeoMeta(item.src);
    const posterValid = item.poster ? await validateImageUrl(item.poster, CONFIG.behavior.validationTimeouts.poster) : false;
    if(meta){
      if(meta.thumb) vimeoPosterCache.set(item.src, meta.thumb);
      vimeoMetaCache.set(item.src, meta);
      return {...item, type:'vimeo', posterValid, _ratio:meta.ratio, _metaResolved: true};
    } else {
      // accept anyway (we will recover meta in background)
      return {...item, type:'vimeo', posterValid, _ratio:16/9, _metaResolved: false, _metaMissing: true};
    }
  }
  return null;
}

/* ============================
   Preload helper to speed first-time loads
   (preload images + local video files)
   ============================ */
function preloadResource(url, as){
  if(!url) return;
  try{
    const existing = document.querySelector('link[rel="preload"][href="'+url+'"]');
    if(existing) return;
    const link = document.createElement('link');
    link.rel = 'preload';
    link.href = url;
    link.as = as;
    if(as === 'image') link.type = 'image/*';
    if(as === 'video') link.type = 'video/mp4';
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
  }catch(e){}
}

/* ============================
   Boot: progressive but eager loading for first-time visitors
   - we replaced previous idle-deferred steps with immediate preloads & mini players
   ============================ */
async function boot(){
  previewContainer.innerHTML='';
  const skeletonSlots = GALLERY_DATA.map(()=>createPreviewShell());
  skeletonSlots.forEach(s=>previewContainer.appendChild(s));

  // validate entries concurrently (but we still update UI as each resolves)
  const tasks = GALLERY_DATA.map((item, idx)=> validateItem(item).then(res=>({idx, res})).catch(()=>({idx, res:null})));
  let firstMainSet = false;

  for (const t of tasks) {
    t.then(({idx, res})=>{
      const slot = previewContainer.children[idx];
      if(res){
        const newPrev = createPreviewFromItem(res);
        previews[idx] = newPrev;
        if(slot) previewContainer.replaceChild(newPrev, slot); else previewContainer.appendChild(newPrev);

        // Preload validated assets ASAP
        if(res.type === 'image'){ preloadResource(res.src,'image'); if(res.thumbValid && res.thumb) preloadResource(res.thumb,'image'); }
        if(res.type === 'video'){ preloadResource(res.src,'video'); if(res.posterValid && res.poster) preloadResource(res.poster,'image'); }
        if(res.type === 'vimeo'){ 
          // store dataset poster (local) for use; actual main poster resolution below
          if(res.posterValid && res.poster){ newPrev.dataset.poster = res.poster; preloadResource(res.poster,'image'); }
          // try fetch meta right away for faster subsequent usage
          fetchVimeoMeta(res.src).then(meta=>{ if(meta && meta.thumb) { vimeoMetaCache.set(res.src,meta); if(!newPrev.querySelector('img')) return; const img = newPrev.querySelector('img'); if(img && img.src===VIMEO_PLACEHOLDER) { validateImageUrl(meta.thumb,800).then(ok=>{ if(ok) img.src=meta.thumb; }); } } }).catch(()=>{});
        }

        // Set main media to first valid item as soon as one appears
        if(!firstMainSet){
          firstMainSet = true;
          currentIndex = idx;
          newPrev.classList.add('active');
          setMainMedia(idx);
        }

        const validCount = Array.from(previewContainer.children).filter(c=>!c.classList.contains('skeleton')).length;
        if(validCount>=2){
          previewContainer.classList.add('visible');
          previewContainer.classList.remove('hidden');
        }
      } else {
        if(slot && slot.parentElement) slot.parentElement.removeChild(slot);
        previews[idx] = undefined;
      }
    });
  }

  // When all validations settled -> finalize
  Promise.allSettled(tasks).then(async ()=>{
    // refresh previews array to the actual DOM children
    previews = Array.from(previewContainer.children);

    // hide preview strip if <=1 valid
    if(previews.length<=1){
      previewContainer.classList.remove('visible');
      previewContainer.classList.add('hidden');
    } else {
      previewContainer.classList.remove('hidden');
      previewContainer.classList.add('visible');
    }

    // Resolve vimeo posters for each vimeo preview now (ensures preview.dataset.mainPoster is set before any transitions)
    const vimeoPreviews = previews.filter(p=>p && getPreviewType(p)==="vimeo");
    await Promise.all(vimeoPreviews.map(async (pv)=>{
      try{
        const poster = await resolveVimeoPosterForMain(pv);
        if(poster){ pv.dataset.mainPoster = poster; // update DOM preview img if placeholder
          const img = pv.querySelector('img');
          if(img && img.src === VIMEO_PLACEHOLDER){ img.src = poster; }
          preloadResource(poster,'image');
        }
      }catch(e){}
      // also schedule background meta recovery if needed
      if(pv && pv.dataset._metaResolved!=="1"){ attemptVimeoMetaRecovery(pv); }
    }));

    // Preload local images/videos across all previews quickly (non-blocking).
    previews.forEach(p=>{
      if(!p) return;
      const t = getPreviewType(p);
      if(t==='image'){ const img = p.querySelector('img'); if(img && img.src) preloadResource(img.src,'image'); }
      if(t==='video'){ const vid = p.querySelector('video'); if(vid && vid.getAttribute('src')) preloadResource(vid.getAttribute('src'),'video'); const poster = vid && vid.getAttribute('poster'); if(poster) preloadResource(poster,'image'); }
      if(t==='vimeo'){ const poster = p.dataset.mainPoster || p.dataset.poster; if(poster) preloadResource(poster,'image'); }
    });

    // Wire preview click handlers now that previews are built
    wirePreviewClicks();

    // Start vimeo minis and local strip loops immediately (no idle)
    try{ await initVimeoStripMiniPlayers(); }catch(e){}
    try{ initLocalStripLoops(); }catch(e){}
  });
}

/* Boot as soon as DOM is ready (helps first-time visitors) */
if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
else boot();

/* ============================
   Controls wiring
   ============================ */
nextBtn.addEventListener("click",(e)=>{ e.stopPropagation(); if(isAnimating) return; nextSlide(); });
prevBtn.addEventListener("click",(e)=>{ e.stopPropagation(); if(isAnimating) return; prevSlide(); });
closeBtn.addEventListener("click",(e)=>{ e.stopPropagation(); closeLightbox(); });

</script>
</body>
</html>
